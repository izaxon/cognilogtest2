var N=typeof WeakRef<"u",T=class{constructor(s){N&&typeof s=="object"?this._weakRef=new WeakRef(s):this._instance=s}deref(){var s,e;let t;return this._weakRef?(t=(s=this._weakRef)==null?void 0:s.deref(),t||delete this._weakRef):(t=this._instance,(e=t==null?void 0:t.isDisposed)!=null&&e.call(t)&&delete this._instance),t}},g="keyborg:focusin",k="keyborg:focusout";function O(s){const e=s.HTMLElement,t=e.prototype.focus;let i=!1;return e.prototype.focus=function(){i=!0},s.document.createElement("button").focus(),e.prototype.focus=t,i}var v=!1;function p(s){const e=s;v||(v=O(e));const t=e.HTMLElement.prototype.focus;if(t.__keyborgNativeFocus)return;e.HTMLElement.prototype.focus=y;const i=new Set,o=r=>{const u=r.target;if(!u)return;const n=new CustomEvent(k,{cancelable:!0,bubbles:!0,composed:!0,detail:{originalEvent:r}});u.dispatchEvent(n)},d=r=>{const u=r.target;if(!u)return;let n=r.composedPath()[0];const l=new Set;for(;n;)n.nodeType===Node.DOCUMENT_FRAGMENT_NODE?(l.add(n),n=n.host):n=n.parentNode;for(const c of i){const a=c.deref();(!a||!l.has(a))&&(i.delete(c),a&&(a.removeEventListener("focusin",d,!0),a.removeEventListener("focusout",o,!0)))}h(u,r.relatedTarget||void 0)},h=(r,u,n)=>{var l;const c=r.shadowRoot;if(c){for(const K of i)if(K.deref()===c)return;c.addEventListener("focusin",d,!0),c.addEventListener("focusout",o,!0),i.add(new T(c));return}const a={relatedTarget:u,originalEvent:n},b=new CustomEvent(g,{cancelable:!0,bubbles:!0,composed:!0,detail:a});b.details=a,(v||f.lastFocusedProgrammatically)&&(a.isFocusedProgrammatically=r===((l=f.lastFocusedProgrammatically)==null?void 0:l.deref()),f.lastFocusedProgrammatically=void 0),r.dispatchEvent(b)},f=e.__keyborgData={focusInHandler:d,focusOutHandler:o,shadowTargets:i};e.document.addEventListener("focusin",e.__keyborgData.focusInHandler,!0),e.document.addEventListener("focusout",e.__keyborgData.focusOutHandler,!0);function y(){const r=e.__keyborgData;return r&&(r.lastFocusedProgrammatically=new T(this)),t.apply(this,arguments)}let _=e.document.activeElement;for(;_&&_.shadowRoot;)h(_),_=_.shadowRoot.activeElement;y.__keyborgNativeFocus=t}function F(s){const e=s,t=e.HTMLElement.prototype,i=t.focus.__keyborgNativeFocus,o=e.__keyborgData;if(o){e.document.removeEventListener("focusin",o.focusInHandler,!0),e.document.removeEventListener("focusout",o.focusOutHandler,!0);for(const d of o.shadowTargets){const h=d.deref();h&&(h.removeEventListener("focusin",o.focusInHandler,!0),h.removeEventListener("focusout",o.focusOutHandler,!0))}o.shadowTargets.clear(),delete e.__keyborgData}i&&(t.focus=i)}var L=500,E=0,M=class{constructor(s,e){this._isNavigatingWithKeyboard_DO_NOT_USE=!1,this._onFocusIn=i=>{if(this._isMouseOrTouchUsedTimer||this.isNavigatingWithKeyboard)return;const o=i.detail;o.relatedTarget&&(o.isFocusedProgrammatically||o.isFocusedProgrammatically===void 0||(this.isNavigatingWithKeyboard=!0))},this._onMouseDown=i=>{i.buttons===0||i.clientX===0&&i.clientY===0&&i.screenX===0&&i.screenY===0||this._onMouseOrTouch()},this._onMouseOrTouch=()=>{const i=this._win;i&&(this._isMouseOrTouchUsedTimer&&i.clearTimeout(this._isMouseOrTouchUsedTimer),this._isMouseOrTouchUsedTimer=i.setTimeout(()=>{delete this._isMouseOrTouchUsedTimer},1e3)),this.isNavigatingWithKeyboard=!1},this._onKeyDown=i=>{this.isNavigatingWithKeyboard?this._shouldDismissKeyboardNavigation(i)&&this._scheduleDismiss():this._shouldTriggerKeyboardNavigation(i)&&(this.isNavigatingWithKeyboard=!0)},this.id="c"+ ++E,this._win=s;const t=s.document;if(e){const i=e.triggerKeys,o=e.dismissKeys;i!=null&&i.length&&(this._triggerKeys=new Set(i)),o!=null&&o.length&&(this._dismissKeys=new Set(o))}t.addEventListener(g,this._onFocusIn,!0),t.addEventListener("mousedown",this._onMouseDown,!0),s.addEventListener("keydown",this._onKeyDown,!0),t.addEventListener("touchstart",this._onMouseOrTouch,!0),t.addEventListener("touchend",this._onMouseOrTouch,!0),t.addEventListener("touchcancel",this._onMouseOrTouch,!0),p(s)}get isNavigatingWithKeyboard(){return this._isNavigatingWithKeyboard_DO_NOT_USE}set isNavigatingWithKeyboard(s){this._isNavigatingWithKeyboard_DO_NOT_USE!==s&&(this._isNavigatingWithKeyboard_DO_NOT_USE=s,this.update())}dispose(){const s=this._win;if(s){this._isMouseOrTouchUsedTimer&&(s.clearTimeout(this._isMouseOrTouchUsedTimer),this._isMouseOrTouchUsedTimer=void 0),this._dismissTimer&&(s.clearTimeout(this._dismissTimer),this._dismissTimer=void 0),F(s);const e=s.document;e.removeEventListener(g,this._onFocusIn,!0),e.removeEventListener("mousedown",this._onMouseDown,!0),s.removeEventListener("keydown",this._onKeyDown,!0),e.removeEventListener("touchstart",this._onMouseOrTouch,!0),e.removeEventListener("touchend",this._onMouseOrTouch,!0),e.removeEventListener("touchcancel",this._onMouseOrTouch,!0),delete this._win}}isDisposed(){return!!this._win}update(){var s,e;const t=(e=(s=this._win)==null?void 0:s.__keyborg)==null?void 0:e.refs;if(t)for(const i of Object.keys(t))m.update(t[i],this.isNavigatingWithKeyboard)}_shouldTriggerKeyboardNavigation(s){var e;if(s.key==="Tab")return!0;const t=(e=this._win)==null?void 0:e.document.activeElement,i=!this._triggerKeys||this._triggerKeys.has(s.keyCode),o=t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable);return i&&!o}_shouldDismissKeyboardNavigation(s){var e;return(e=this._dismissKeys)==null?void 0:e.has(s.keyCode)}_scheduleDismiss(){const s=this._win;if(s){this._dismissTimer&&(s.clearTimeout(this._dismissTimer),this._dismissTimer=void 0);const e=s.document.activeElement;this._dismissTimer=s.setTimeout(()=>{this._dismissTimer=void 0;const t=s.document.activeElement;e&&t&&e===t&&(this.isNavigatingWithKeyboard=!1)},L)}}},m=class w{constructor(e,t){this._cb=[],this._id="k"+ ++E,this._win=e;const i=e.__keyborg;i?(this._core=i.core,i.refs[this._id]=this):(this._core=new M(e,t),e.__keyborg={core:this._core,refs:{[this._id]:this}})}static create(e,t){return new w(e,t)}static dispose(e){e.dispose()}static update(e,t){e._cb.forEach(i=>i(t))}dispose(){var e;const t=(e=this._win)==null?void 0:e.__keyborg;t!=null&&t.refs[this._id]&&(delete t.refs[this._id],Object.keys(t.refs).length===0&&(t.core.dispose(),delete this._win.__keyborg)),this._cb=[],delete this._core,delete this._win}isNavigatingWithKeyboard(){var e;return!!((e=this._core)!=null&&e.isNavigatingWithKeyboard)}subscribe(e){this._cb.push(e)}unsubscribe(e){const t=this._cb.indexOf(e);t>=0&&this._cb.splice(t,1)}setVal(e){this._core&&(this._core.isNavigatingWithKeyboard=e)}};function W(s,e){return m.create(s,e)}function D(s){m.dispose(s)}/*!
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License.
 */export{g as K,W as c,D as d};
