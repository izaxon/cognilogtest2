import{C as S,a as Ge}from"./vscode-jsonrpc-ByHGxxVC.js";import{P as g,R as x}from"./vscode-languageserver-types-NoPvPymt.js";import{d as K,E as yr,L as vr,b as Fe,c as wr,e as at}from"./chevrotain-D1YjmfcG.js";import{L as Sr}from"./chevrotain-allstar-DEMvE_-m.js";import{U as z,a as U}from"./vscode-uri-D3CQYEzw.js";import{B as kr,g as xr}from"./@chevrotain-D6nI8fqk.js";import{T as Nr}from"./vscode-languageserver-textdocument-CKBVUiR3.js";function w(n){return typeof n=="object"&&n!==null&&typeof n.$type=="string"}function T(n){return typeof n=="object"&&n!==null&&typeof n.$refText=="string"}function br(n){return typeof n=="object"&&n!==null&&typeof n.name=="string"&&typeof n.type=="string"&&typeof n.path=="string"}function J(n){return typeof n=="object"&&n!==null&&w(n.container)&&T(n.reference)&&typeof n.message=="string"}class Rr{constructor(){this.subtypes={},this.allSubtypes={}}isInstance(e,t){return w(e)&&this.isSubtype(e.$type,t)}isSubtype(e,t){if(e===t)return!0;let r=this.subtypes[e];r||(r=this.subtypes[e]={});const s=r[t];if(s!==void 0)return s;{const i=this.computeIsSubtype(e,t);return r[t]=i,i}}getAllSubTypes(e){const t=this.allSubtypes[e];if(t)return t;{const r=this.getAllTypes(),s=[];for(const i of r)this.isSubtype(i,e)&&s.push(i);return this.allSubtypes[e]=s,s}}}function j(n){return typeof n=="object"&&n!==null&&Array.isArray(n.content)}function ot(n){return typeof n=="object"&&n!==null&&typeof n.tokenType=="object"}function ct(n){return j(n)&&typeof n.fullText=="string"}class v{constructor(e,t){this.startFn=e,this.nextFn=t}iterator(){const e={state:this.startFn(),next:()=>this.nextFn(e.state),[Symbol.iterator]:()=>e};return e}[Symbol.iterator](){return this.iterator()}isEmpty(){return!!this.iterator().next().done}count(){const e=this.iterator();let t=0,r=e.next();for(;!r.done;)t++,r=e.next();return t}toArray(){const e=[],t=this.iterator();let r;do r=t.next(),r.value!==void 0&&e.push(r.value);while(!r.done);return e}toSet(){return new Set(this)}toMap(e,t){const r=this.map(s=>[e?e(s):s,t?t(s):s]);return new Map(r)}toString(){return this.join()}concat(e){const t=e[Symbol.iterator]();return new v(()=>({first:this.startFn(),firstDone:!1}),r=>{let s;if(!r.firstDone){do if(s=this.nextFn(r.first),!s.done)return s;while(!s.done);r.firstDone=!0}do if(s=t.next(),!s.done)return s;while(!s.done);return N})}join(e=","){const t=this.iterator();let r="",s,i=!1;do s=t.next(),s.done||(i&&(r+=e),r+=Tr(s.value)),i=!0;while(!s.done);return r}indexOf(e,t=0){const r=this.iterator();let s=0,i=r.next();for(;!i.done;){if(s>=t&&i.value===e)return s;i=r.next(),s++}return-1}every(e){const t=this.iterator();let r=t.next();for(;!r.done;){if(!e(r.value))return!1;r=t.next()}return!0}some(e){const t=this.iterator();let r=t.next();for(;!r.done;){if(e(r.value))return!0;r=t.next()}return!1}forEach(e){const t=this.iterator();let r=0,s=t.next();for(;!s.done;)e(s.value,r),s=t.next(),r++}map(e){return new v(this.startFn,t=>{const{done:r,value:s}=this.nextFn(t);return r?N:{done:!1,value:e(s)}})}filter(e){return new v(this.startFn,t=>{let r;do if(r=this.nextFn(t),!r.done&&e(r.value))return r;while(!r.done);return N})}nonNullable(){return this.filter(e=>e!=null)}reduce(e,t){const r=this.iterator();let s=t,i=r.next();for(;!i.done;)s===void 0?s=i.value:s=e(s,i.value),i=r.next();return s}reduceRight(e,t){return this.recursiveReduce(this.iterator(),e,t)}recursiveReduce(e,t,r){const s=e.next();if(s.done)return r;const i=this.recursiveReduce(e,t,r);return i===void 0?s.value:t(i,s.value)}find(e){const t=this.iterator();let r=t.next();for(;!r.done;){if(e(r.value))return r.value;r=t.next()}}findIndex(e){const t=this.iterator();let r=0,s=t.next();for(;!s.done;){if(e(s.value))return r;s=t.next(),r++}return-1}includes(e){const t=this.iterator();let r=t.next();for(;!r.done;){if(r.value===e)return!0;r=t.next()}return!1}flatMap(e){return new v(()=>({this:this.startFn()}),t=>{do{if(t.iterator){const i=t.iterator.next();if(i.done)t.iterator=void 0;else return i}const{done:r,value:s}=this.nextFn(t.this);if(!r){const i=e(s);if(H(i))t.iterator=i[Symbol.iterator]();else return{done:!1,value:i}}}while(t.iterator);return N})}flat(e){if(e===void 0&&(e=1),e<=0)return this;const t=e>1?this.flat(e-1):this;return new v(()=>({this:t.startFn()}),r=>{do{if(r.iterator){const a=r.iterator.next();if(a.done)r.iterator=void 0;else return a}const{done:s,value:i}=t.nextFn(r.this);if(!s)if(H(i))r.iterator=i[Symbol.iterator]();else return{done:!1,value:i}}while(r.iterator);return N})}head(){const t=this.iterator().next();if(!t.done)return t.value}tail(e=1){return new v(()=>{const t=this.startFn();for(let r=0;r<e;r++)if(this.nextFn(t).done)return t;return t},this.nextFn)}limit(e){return new v(()=>({size:0,state:this.startFn()}),t=>(t.size++,t.size>e?N:this.nextFn(t.state)))}distinct(e){const t=new Set;return this.filter(r=>{const s=e?e(r):r;return t.has(s)?!1:(t.add(s),!0)})}exclude(e,t){const r=new Set;for(const s of e){const i=t?t(s):s;r.add(i)}return this.filter(s=>{const i=t?t(s):s;return!r.has(i)})}}function Tr(n){return typeof n=="string"?n:typeof n>"u"?"undefined":typeof n.toString=="function"?n.toString():Object.prototype.toString.call(n)}function H(n){return!!n&&typeof n[Symbol.iterator]=="function"}const Dr=new v(()=>{},()=>N),N=Object.freeze({done:!0,value:void 0});function y(...n){if(n.length===1){const e=n[0];if(e instanceof v)return e;if(H(e))return new v(()=>e[Symbol.iterator](),t=>t.next());if(typeof e.length=="number")return new v(()=>({index:0}),t=>t.index<e.length?{done:!1,value:e[t.index++]}:N)}return n.length>1?new v(()=>({collIndex:0,arrIndex:0}),e=>{do{if(e.iterator){const t=e.iterator.next();if(!t.done)return t;e.iterator=void 0}if(e.array){if(e.arrIndex<e.array.length)return{done:!1,value:e.array[e.arrIndex++]};e.array=void 0,e.arrIndex=0}if(e.collIndex<n.length){const t=n[e.collIndex++];H(t)?e.iterator=t[Symbol.iterator]():t&&typeof t.length=="number"&&(e.array=t)}}while(e.iterator||e.array||e.collIndex<n.length);return N}):Dr}class be extends v{constructor(e,t,r){super(()=>({iterators:r!=null&&r.includeRoot?[[e][Symbol.iterator]()]:[t(e)[Symbol.iterator]()],pruned:!1}),s=>{for(s.pruned&&(s.iterators.pop(),s.pruned=!1);s.iterators.length>0;){const a=s.iterators[s.iterators.length-1].next();if(a.done)s.iterators.pop();else return s.iterators.push(t(a.value)[Symbol.iterator]()),a}return N})}iterator(){const e={state:this.startFn(),next:()=>this.nextFn(e.state),prune:()=>{e.state.pruned=!0},[Symbol.iterator]:()=>e};return e}}var pe;(function(n){function e(i){return i.reduce((a,o)=>a+o,0)}n.sum=e;function t(i){return i.reduce((a,o)=>a*o,0)}n.product=t;function r(i){return i.reduce((a,o)=>Math.min(a,o))}n.min=r;function s(i){return i.reduce((a,o)=>Math.max(a,o))}n.max=s})(pe||(pe={}));function ge(n){return new be(n,e=>j(e)?e.content:[],{includeRoot:!0})}function Ar(n,e){for(;n.container;)if(n=n.container,n===e)return!0;return!1}function ye(n){return{start:{character:n.startColumn-1,line:n.startLine-1},end:{character:n.endColumn,line:n.endLine-1}}}function q(n){if(!n)return;const{offset:e,end:t,range:r}=n;return{range:r,offset:e,end:t,length:t-e}}var C;(function(n){n[n.Before=0]="Before",n[n.After=1]="After",n[n.OverlapFront=2]="OverlapFront",n[n.OverlapBack=3]="OverlapBack",n[n.Inside=4]="Inside"})(C||(C={}));function Er(n,e){if(n.end.line<e.start.line||n.end.line===e.start.line&&n.end.character<n.start.character)return C.Before;if(n.start.line>e.end.line||n.start.line===e.end.line&&n.start.character>e.end.character)return C.After;const t=n.start.line>e.start.line||n.start.line===e.start.line&&n.start.character>=e.start.character,r=n.end.line<e.end.line||n.end.line===e.end.line&&n.end.character<=e.end.character;return t&&r?C.Inside:t?C.OverlapBack:C.OverlapFront}function Pr(n,e){return Er(n,e)>C.After}const Lr=/^[\w\p{L}]$/u;function Cr(n,e){if(n){const t=$r(n,!0);if(t&&Be(t,e))return t;if(ct(n)){const r=n.content.findIndex(s=>!s.hidden);for(let s=r-1;s>=0;s--){const i=n.content[s];if(Be(i,e))return i}}}}function Be(n,e){return ot(n)&&e.includes(n.tokenType.name)}function $r(n,e=!0){for(;n.container;){const t=n.container;let r=t.content.indexOf(n);for(;r>0;){r--;const s=t.content[r];if(e||!s.hidden)return s}n=t}}class ut extends Error{constructor(e,t){super(e?`${t} at ${e.range.start.line}:${e.range.start.character}`:t)}}function te(n){throw new Error("Error! The input value was not handled.")}const oe="AbstractRule",ce="AbstractType",Ue="Condition",Ir="TypeDefinition",je="ValueLiteral",lt="AbstractElement";function Mr(n){return m.isInstance(n,lt)}const _r="ArrayLiteral",Or="ArrayType",dt="BooleanLiteral";function Gr(n){return m.isInstance(n,dt)}const ft="Conjunction";function Fr(n){return m.isInstance(n,ft)}const ht="Disjunction";function Br(n){return m.isInstance(n,ht)}const Ur="Grammar",mt="InferredType";function pt(n){return m.isInstance(n,mt)}const gt="Interface";function yt(n){return m.isInstance(n,gt)}const vt="Negation";function jr(n){return m.isInstance(n,vt)}const Vr="NumberLiteral",zr="Parameter",wt="ParameterReference";function Wr(n){return m.isInstance(n,wt)}const St="ParserRule";function b(n){return m.isInstance(n,St)}const Kr="ReferenceType",Jr="ReturnType";function Hr(n){return m.isInstance(n,Jr)}const kt="SimpleType";function qr(n){return m.isInstance(n,kt)}const Qr="StringLiteral",ve="TerminalRule";function F(n){return m.isInstance(n,ve)}const xt="Type";function Nt(n){return m.isInstance(n,xt)}const Yr="UnionType",bt="Action";function re(n){return m.isInstance(n,bt)}const Rt="Alternatives";function Tt(n){return m.isInstance(n,Rt)}const Dt="Assignment";function M(n){return m.isInstance(n,Dt)}const At="CharacterRange";function Xr(n){return m.isInstance(n,At)}const Et="CrossReference";function Re(n){return m.isInstance(n,Et)}const Pt="EndOfFile";function Zr(n){return m.isInstance(n,Pt)}const Lt="Group";function Te(n){return m.isInstance(n,Lt)}const Ct="Keyword";function _(n){return m.isInstance(n,Ct)}const $t="NegatedToken";function en(n){return m.isInstance(n,$t)}const It="RegexToken";function tn(n){return m.isInstance(n,It)}const Mt="RuleCall";function O(n){return m.isInstance(n,Mt)}const _t="TerminalAlternatives";function rn(n){return m.isInstance(n,_t)}const Ot="TerminalGroup";function nn(n){return m.isInstance(n,Ot)}const Gt="TerminalRuleCall";function sn(n){return m.isInstance(n,Gt)}const Ft="UnorderedGroup";function Bt(n){return m.isInstance(n,Ft)}const Ut="UntilToken";function an(n){return m.isInstance(n,Ut)}const jt="Wildcard";function on(n){return m.isInstance(n,jt)}class Vt extends Rr{getAllTypes(){return["AbstractElement","AbstractRule","AbstractType","Action","Alternatives","ArrayLiteral","ArrayType","Assignment","BooleanLiteral","CharacterRange","Condition","Conjunction","CrossReference","Disjunction","EndOfFile","Grammar","GrammarImport","Group","InferredType","Interface","Keyword","NamedArgument","NegatedToken","Negation","NumberLiteral","Parameter","ParameterReference","ParserRule","ReferenceType","RegexToken","ReturnType","RuleCall","SimpleType","StringLiteral","TerminalAlternatives","TerminalGroup","TerminalRule","TerminalRuleCall","Type","TypeAttribute","TypeDefinition","UnionType","UnorderedGroup","UntilToken","ValueLiteral","Wildcard"]}computeIsSubtype(e,t){switch(e){case bt:case Rt:case Dt:case At:case Et:case Pt:case Lt:case Ct:case $t:case It:case Mt:case _t:case Ot:case Gt:case Ft:case Ut:case jt:return this.isSubtype(lt,t);case _r:case Vr:case Qr:return this.isSubtype(je,t);case Or:case Kr:case kt:case Yr:return this.isSubtype(Ir,t);case dt:return this.isSubtype(Ue,t)||this.isSubtype(je,t);case ft:case ht:case vt:case wt:return this.isSubtype(Ue,t);case mt:case gt:case xt:return this.isSubtype(ce,t);case St:return this.isSubtype(oe,t)||this.isSubtype(ce,t);case ve:return this.isSubtype(oe,t);default:return!1}}getReferenceType(e){const t=`${e.container.$type}:${e.property}`;switch(t){case"Action:type":case"CrossReference:type":case"Interface:superTypes":case"ParserRule:returnType":case"SimpleType:typeRef":return ce;case"Grammar:hiddenTokens":case"ParserRule:hiddenTokens":case"RuleCall:rule":return oe;case"Grammar:usedGrammars":return Ur;case"NamedArgument:parameter":case"ParameterReference:parameter":return zr;case"TerminalRuleCall:rule":return ve;default:throw new Error(`${t} is not a valid reference id.`)}}getTypeMetaData(e){switch(e){case"AbstractElement":return{name:"AbstractElement",properties:[{name:"cardinality"},{name:"lookahead"}]};case"ArrayLiteral":return{name:"ArrayLiteral",properties:[{name:"elements",defaultValue:[]}]};case"ArrayType":return{name:"ArrayType",properties:[{name:"elementType"}]};case"BooleanLiteral":return{name:"BooleanLiteral",properties:[{name:"true",defaultValue:!1}]};case"Conjunction":return{name:"Conjunction",properties:[{name:"left"},{name:"right"}]};case"Disjunction":return{name:"Disjunction",properties:[{name:"left"},{name:"right"}]};case"Grammar":return{name:"Grammar",properties:[{name:"definesHiddenTokens",defaultValue:!1},{name:"hiddenTokens",defaultValue:[]},{name:"imports",defaultValue:[]},{name:"interfaces",defaultValue:[]},{name:"isDeclared",defaultValue:!1},{name:"name"},{name:"rules",defaultValue:[]},{name:"types",defaultValue:[]},{name:"usedGrammars",defaultValue:[]}]};case"GrammarImport":return{name:"GrammarImport",properties:[{name:"path"}]};case"InferredType":return{name:"InferredType",properties:[{name:"name"}]};case"Interface":return{name:"Interface",properties:[{name:"attributes",defaultValue:[]},{name:"name"},{name:"superTypes",defaultValue:[]}]};case"NamedArgument":return{name:"NamedArgument",properties:[{name:"calledByName",defaultValue:!1},{name:"parameter"},{name:"value"}]};case"Negation":return{name:"Negation",properties:[{name:"value"}]};case"NumberLiteral":return{name:"NumberLiteral",properties:[{name:"value"}]};case"Parameter":return{name:"Parameter",properties:[{name:"name"}]};case"ParameterReference":return{name:"ParameterReference",properties:[{name:"parameter"}]};case"ParserRule":return{name:"ParserRule",properties:[{name:"dataType"},{name:"definesHiddenTokens",defaultValue:!1},{name:"definition"},{name:"entry",defaultValue:!1},{name:"fragment",defaultValue:!1},{name:"hiddenTokens",defaultValue:[]},{name:"inferredType"},{name:"name"},{name:"parameters",defaultValue:[]},{name:"returnType"},{name:"wildcard",defaultValue:!1}]};case"ReferenceType":return{name:"ReferenceType",properties:[{name:"referenceType"}]};case"ReturnType":return{name:"ReturnType",properties:[{name:"name"}]};case"SimpleType":return{name:"SimpleType",properties:[{name:"primitiveType"},{name:"stringType"},{name:"typeRef"}]};case"StringLiteral":return{name:"StringLiteral",properties:[{name:"value"}]};case"TerminalRule":return{name:"TerminalRule",properties:[{name:"definition"},{name:"fragment",defaultValue:!1},{name:"hidden",defaultValue:!1},{name:"name"},{name:"type"}]};case"Type":return{name:"Type",properties:[{name:"name"},{name:"type"}]};case"TypeAttribute":return{name:"TypeAttribute",properties:[{name:"defaultValue"},{name:"isOptional",defaultValue:!1},{name:"name"},{name:"type"}]};case"UnionType":return{name:"UnionType",properties:[{name:"types",defaultValue:[]}]};case"Action":return{name:"Action",properties:[{name:"cardinality"},{name:"feature"},{name:"inferredType"},{name:"lookahead"},{name:"operator"},{name:"type"}]};case"Alternatives":return{name:"Alternatives",properties:[{name:"cardinality"},{name:"elements",defaultValue:[]},{name:"lookahead"}]};case"Assignment":return{name:"Assignment",properties:[{name:"cardinality"},{name:"feature"},{name:"lookahead"},{name:"operator"},{name:"terminal"}]};case"CharacterRange":return{name:"CharacterRange",properties:[{name:"cardinality"},{name:"left"},{name:"lookahead"},{name:"right"}]};case"CrossReference":return{name:"CrossReference",properties:[{name:"cardinality"},{name:"deprecatedSyntax",defaultValue:!1},{name:"lookahead"},{name:"terminal"},{name:"type"}]};case"EndOfFile":return{name:"EndOfFile",properties:[{name:"cardinality"},{name:"lookahead"}]};case"Group":return{name:"Group",properties:[{name:"cardinality"},{name:"elements",defaultValue:[]},{name:"guardCondition"},{name:"lookahead"}]};case"Keyword":return{name:"Keyword",properties:[{name:"cardinality"},{name:"lookahead"},{name:"value"}]};case"NegatedToken":return{name:"NegatedToken",properties:[{name:"cardinality"},{name:"lookahead"},{name:"terminal"}]};case"RegexToken":return{name:"RegexToken",properties:[{name:"cardinality"},{name:"lookahead"},{name:"regex"}]};case"RuleCall":return{name:"RuleCall",properties:[{name:"arguments",defaultValue:[]},{name:"cardinality"},{name:"lookahead"},{name:"rule"}]};case"TerminalAlternatives":return{name:"TerminalAlternatives",properties:[{name:"cardinality"},{name:"elements",defaultValue:[]},{name:"lookahead"}]};case"TerminalGroup":return{name:"TerminalGroup",properties:[{name:"cardinality"},{name:"elements",defaultValue:[]},{name:"lookahead"}]};case"TerminalRuleCall":return{name:"TerminalRuleCall",properties:[{name:"cardinality"},{name:"lookahead"},{name:"rule"}]};case"UnorderedGroup":return{name:"UnorderedGroup",properties:[{name:"cardinality"},{name:"elements",defaultValue:[]},{name:"lookahead"}]};case"UntilToken":return{name:"UntilToken",properties:[{name:"cardinality"},{name:"lookahead"},{name:"terminal"}]};case"Wildcard":return{name:"Wildcard",properties:[{name:"cardinality"},{name:"lookahead"}]};default:return{name:e,properties:[]}}}}const m=new Vt;function cn(n){for(const[e,t]of Object.entries(n))e.startsWith("$")||(Array.isArray(t)?t.forEach((r,s)=>{w(r)&&(r.$container=n,r.$containerProperty=e,r.$containerIndex=s)}):w(t)&&(t.$container=n,t.$containerProperty=e))}function ne(n,e){let t=n;for(;t;){if(e(t))return t;t=t.$container}}function D(n){const t=un(n).$document;if(!t)throw new Error("AST node has no document.");return t}function un(n){for(;n.$container;)n=n.$container;return n}function De(n,e){if(!n)throw new Error("Node must be an AstNode.");const t=e==null?void 0:e.range;return new v(()=>({keys:Object.keys(n),keyIndex:0,arrayIndex:0}),r=>{for(;r.keyIndex<r.keys.length;){const s=r.keys[r.keyIndex];if(!s.startsWith("$")){const i=n[s];if(w(i)){if(r.keyIndex++,Ve(i,t))return{done:!1,value:i}}else if(Array.isArray(i)){for(;r.arrayIndex<i.length;){const a=r.arrayIndex++,o=i[a];if(w(o)&&Ve(o,t))return{done:!1,value:o}}r.arrayIndex=0}}r.keyIndex++}return N})}function W(n,e){if(!n)throw new Error("Root node must be an AstNode.");return new be(n,t=>De(t,e))}function B(n,e){if(!n)throw new Error("Root node must be an AstNode.");return new be(n,t=>De(t,e),{includeRoot:!0})}function Ve(n,e){var t;if(!e)return!0;const r=(t=n.$cstNode)===null||t===void 0?void 0:t.range;return r?Pr(r,e):!1}function zt(n){return new v(()=>({keys:Object.keys(n),keyIndex:0,arrayIndex:0}),e=>{for(;e.keyIndex<e.keys.length;){const t=e.keys[e.keyIndex];if(!t.startsWith("$")){const r=n[t];if(T(r))return e.keyIndex++,{done:!1,value:{reference:r,container:n,property:t}};if(Array.isArray(r)){for(;e.arrayIndex<r.length;){const s=e.arrayIndex++,i=r[s];if(T(i))return{done:!1,value:{reference:i,container:n,property:t,index:s}}}e.arrayIndex=0}}e.keyIndex++}return N})}function ln(n,e){const t=n.getTypeMetaData(e.$type),r=e;for(const s of t.properties)s.defaultValue!==void 0&&r[s.name]===void 0&&(r[s.name]=Wt(s.defaultValue))}function Wt(n){return Array.isArray(n)?[...n.map(Wt)]:n}const dn=/\r?\n/gm,fn=new xr;class hn extends kr{constructor(){super(...arguments),this.isStarting=!0,this.endRegexpStack=[],this.multiline=!1}get endRegex(){return this.endRegexpStack.join("")}reset(e){this.multiline=!1,this.regex=e,this.startRegexp="",this.isStarting=!0,this.endRegexpStack=[]}visitGroup(e){e.quantifier&&(this.isStarting=!1,this.endRegexpStack=[])}visitCharacter(e){const t=String.fromCharCode(e.value);if(!this.multiline&&t===`
`&&(this.multiline=!0),e.quantifier)this.isStarting=!1,this.endRegexpStack=[];else{const r=se(t);this.endRegexpStack.push(r),this.isStarting&&(this.startRegexp+=r)}}visitSet(e){if(!this.multiline){const t=this.regex.substring(e.loc.begin,e.loc.end),r=new RegExp(t);this.multiline=!!`
`.match(r)}if(e.quantifier)this.isStarting=!1,this.endRegexpStack=[];else{const t=this.regex.substring(e.loc.begin,e.loc.end);this.endRegexpStack.push(t),this.isStarting&&(this.startRegexp+=t)}}visitChildren(e){e.type==="Group"&&e.quantifier||super.visitChildren(e)}}const ue=new hn;function mn(n){try{return typeof n=="string"&&(n=new RegExp(n)),n=n.toString(),ue.reset(n),ue.visit(fn.pattern(n)),ue.multiline}catch{return!1}}function ze(n){return(typeof n=="string"?new RegExp(n):n).test(" ")}function se(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function pn(n){return Array.prototype.map.call(n,e=>/\w/.test(e)?`[${e.toLowerCase()}${e.toUpperCase()}]`:se(e)).join("")}function gn(n,e){const t=yn(n),r=e.match(t);return!!r&&r[0].length>0}function yn(n){typeof n=="string"&&(n=new RegExp(n));const e=n,t=n.source;let r=0;function s(){let i="",a;function o(u){i+=t.substr(r,u),r+=u}function c(u){i+="(?:"+t.substr(r,u)+"|$)",r+=u}for(;r<t.length;)switch(t[r]){case"\\":switch(t[r+1]){case"c":c(3);break;case"x":c(4);break;case"u":e.unicode?t[r+2]==="{"?c(t.indexOf("}",r)-r+1):c(6):c(2);break;case"p":case"P":e.unicode?c(t.indexOf("}",r)-r+1):c(2);break;case"k":c(t.indexOf(">",r)-r+1);break;default:c(2);break}break;case"[":a=/\[(?:\\.|.)*?\]/g,a.lastIndex=r,a=a.exec(t)||[],c(a[0].length);break;case"|":case"^":case"$":case"*":case"+":case"?":o(1);break;case"{":a=/\{\d+,?\d*\}/g,a.lastIndex=r,a=a.exec(t),a?o(a[0].length):c(1);break;case"(":if(t[r+1]==="?")switch(t[r+2]){case":":i+="(?:",r+=3,i+=s()+"|$)";break;case"=":i+="(?=",r+=3,i+=s()+")";break;case"!":a=r,r+=3,s(),i+=t.substr(a,r-a);break;case"<":switch(t[r+3]){case"=":case"!":a=r,r+=4,s(),i+=t.substr(a,r-a);break;default:o(t.indexOf(">",r)-r+1),i+=s()+"|$)";break}break}else o(1),i+=s()+"|$)";break;case")":return++r,i;default:c(1);break}return i}return new RegExp(s(),n.flags)}function vn(n){return n.rules.find(e=>b(e)&&e.entry)}function wn(n){return n.rules.filter(e=>F(e)&&e.hidden)}function Kt(n,e){const t=new Set,r=vn(n);if(!r)return new Set(n.rules);const s=[r].concat(wn(n));for(const a of s)Jt(a,t,e);const i=new Set;for(const a of n.rules)(t.has(a.name)||F(a)&&a.hidden)&&i.add(a);return i}function Jt(n,e,t){e.add(n.name),W(n).forEach(r=>{if(O(r)||t){const s=r.rule.ref;s&&!e.has(s.name)&&Jt(s,e,t)}})}function Sn(n){if(n.terminal)return n.terminal;if(n.type.ref){const e=qt(n.type.ref);return e==null?void 0:e.terminal}}function kn(n){return n.hidden&&!Pe(n).test(" ")}function xn(n,e){return!n||!e?[]:Ae(n,e,n.astNode,!0)}function Ht(n,e,t){if(!n||!e)return;const r=Ae(n,e,n.astNode,!0);if(r.length!==0)return t!==void 0?t=Math.max(0,Math.min(t,r.length-1)):t=0,r[t]}function Ae(n,e,t,r){if(!r){const s=ne(n.grammarSource,M);if(s&&s.feature===e)return[n]}return j(n)&&n.astNode===t?n.content.flatMap(s=>Ae(s,e,t,!1)):[]}function Nn(n,e,t){if(!n)return;const r=bn(n,e,n==null?void 0:n.astNode);if(r.length!==0)return t!==void 0?t=Math.max(0,Math.min(t,r.length-1)):t=0,r[t]}function bn(n,e,t){if(n.astNode!==t)return[];if(_(n.grammarSource)&&n.grammarSource.value===e)return[n];const r=ge(n).iterator();let s;const i=[];do if(s=r.next(),!s.done){const a=s.value;a.astNode===t?_(a.grammarSource)&&a.grammarSource.value===e&&i.push(a):r.prune()}while(!s.done);return i}function Rn(n){var e;const t=n.astNode;for(;t===((e=n.container)===null||e===void 0?void 0:e.astNode);){const r=ne(n.grammarSource,M);if(r)return r;n=n.container}}function qt(n){let e=n;return pt(e)&&(re(e.$container)?e=e.$container.$container:b(e.$container)?e=e.$container:te(e.$container)),Qt(n,e,new Map)}function Qt(n,e,t){var r;function s(i,a){let o;return ne(i,M)||(o=Qt(a,a,t)),t.set(n,o),o}if(t.has(n))return t.get(n);t.set(n,void 0);for(const i of W(e)){if(M(i)&&i.feature.toLowerCase()==="name")return t.set(n,i),i;if(O(i)&&b(i.rule.ref))return s(i,i.rule.ref);if(qr(i)&&(!((r=i.typeRef)===null||r===void 0)&&r.ref))return s(i,i.typeRef.ref)}}function Ee(n){return Yt(n,new Set)}function Yt(n,e){if(e.has(n))return!0;e.add(n);for(const t of W(n))if(O(t)){if(!t.rule.ref||b(t.rule.ref)&&!Yt(t.rule.ref,e))return!1}else{if(M(t))return!1;if(re(t))return!1}return!!n.definition}function Xt(n){if(n.inferredType)return n.inferredType.name;if(n.dataType)return n.dataType;if(n.returnType){const e=n.returnType.ref;if(e){if(b(e))return e.name;if(yt(e)||Nt(e))return e.name}}}function ie(n){var e;if(b(n))return Ee(n)?n.name:(e=Xt(n))!==null&&e!==void 0?e:n.name;if(yt(n)||Nt(n)||Hr(n))return n.name;if(re(n)){const t=Tn(n);if(t)return t}else if(pt(n))return n.name;throw new Error("Cannot get name of Unknown Type")}function Tn(n){var e;if(n.inferredType)return n.inferredType.name;if(!((e=n.type)===null||e===void 0)&&e.ref)return ie(n.type.ref)}function Dn(n){var e,t,r;return F(n)?(t=(e=n.type)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:"string":Ee(n)?n.name:(r=Xt(n))!==null&&r!==void 0?r:n.name}function Pe(n){const e={s:!1,i:!1,u:!1},t=V(n.definition,e),r=Object.entries(e).filter(([,s])=>s).map(([s])=>s).join("");return new RegExp(t,r)}const Le=/[\s\S]/.source;function V(n,e){if(rn(n))return An(n);if(nn(n))return En(n);if(Xr(n))return Cn(n);if(sn(n)){const t=n.rule.ref;if(!t)throw new Error("Missing rule reference.");return P(V(t.definition),{cardinality:n.cardinality,lookahead:n.lookahead})}else{if(en(n))return Ln(n);if(an(n))return Pn(n);if(tn(n)){const t=n.regex.lastIndexOf("/"),r=n.regex.substring(1,t),s=n.regex.substring(t+1);return e&&(e.i=s.includes("i"),e.s=s.includes("s"),e.u=s.includes("u")),P(r,{cardinality:n.cardinality,lookahead:n.lookahead,wrap:!1})}else{if(on(n))return P(Le,{cardinality:n.cardinality,lookahead:n.lookahead});throw new Error(`Invalid terminal element: ${n==null?void 0:n.$type}`)}}}function An(n){return P(n.elements.map(e=>V(e)).join("|"),{cardinality:n.cardinality,lookahead:n.lookahead})}function En(n){return P(n.elements.map(e=>V(e)).join(""),{cardinality:n.cardinality,lookahead:n.lookahead})}function Pn(n){return P(`${Le}*?${V(n.terminal)}`,{cardinality:n.cardinality,lookahead:n.lookahead})}function Ln(n){return P(`(?!${V(n.terminal)})${Le}*?`,{cardinality:n.cardinality,lookahead:n.lookahead})}function Cn(n){return n.right?P(`[${le(n.left)}-${le(n.right)}]`,{cardinality:n.cardinality,lookahead:n.lookahead,wrap:!1}):P(le(n.left),{cardinality:n.cardinality,lookahead:n.lookahead,wrap:!1})}function le(n){return se(n.value)}function P(n,e){var t;return(e.wrap!==!1||e.lookahead)&&(n=`(${(t=e.lookahead)!==null&&t!==void 0?t:""}${n})`),e.cardinality?`${n}${e.cardinality}`:n}function $n(n){const e=[],t=n.Grammar;for(const r of t.rules)F(r)&&kn(r)&&mn(Pe(r))&&e.push(r.name);return{multilineCommentRules:e,nameRegexp:Lr}}class In{constructor(){this.nodeStack=[]}get current(){return this.nodeStack[this.nodeStack.length-1]}buildRootNode(e){return this.rootNode=new er(e),this.rootNode.root=this.rootNode,this.nodeStack=[this.rootNode],this.rootNode}buildCompositeNode(e){const t=new Ce;return t.grammarSource=e,t.root=this.rootNode,this.current.content.push(t),this.nodeStack.push(t),t}buildLeafNode(e,t){const r=new we(e.startOffset,e.image.length,ye(e),e.tokenType,!1);return r.grammarSource=t,r.root=this.rootNode,this.current.content.push(r),r}removeNode(e){const t=e.container;if(t){const r=t.content.indexOf(e);r>=0&&t.content.splice(r,1)}}construct(e){const t=this.current;typeof e.$type=="string"&&(this.current.astNode=e),e.$cstNode=t;const r=this.nodeStack.pop();(r==null?void 0:r.content.length)===0&&this.removeNode(r)}addHiddenTokens(e){for(const t of e){const r=new we(t.startOffset,t.image.length,ye(t),t.tokenType,!0);r.root=this.rootNode,this.addHiddenToken(this.rootNode,r)}}addHiddenToken(e,t){const{offset:r,end:s}=t;for(let i=0;i<e.content.length;i++){const a=e.content[i],{offset:o,end:c}=a;if(j(a)&&r>o&&s<c){this.addHiddenToken(a,t);return}else if(s<=o){e.content.splice(i,0,t);return}}e.content.push(t)}}class Zt{get parent(){return this.container}get feature(){return this.grammarSource}get hidden(){return!1}get astNode(){var e,t;const r=typeof((e=this._astNode)===null||e===void 0?void 0:e.$type)=="string"?this._astNode:(t=this.container)===null||t===void 0?void 0:t.astNode;if(!r)throw new Error("This node has no associated AST element");return r}set astNode(e){this._astNode=e}get element(){return this.astNode}get text(){return this.root.fullText.substring(this.offset,this.end)}}class we extends Zt{get offset(){return this._offset}get length(){return this._length}get end(){return this._offset+this._length}get hidden(){return this._hidden}get tokenType(){return this._tokenType}get range(){return this._range}constructor(e,t,r,s,i=!1){super(),this._hidden=i,this._offset=e,this._tokenType=s,this._length=t,this._range=r}}class Ce extends Zt{constructor(){super(...arguments),this.content=new $e(this)}get children(){return this.content}get offset(){var e,t;return(t=(e=this.firstNonHiddenNode)===null||e===void 0?void 0:e.offset)!==null&&t!==void 0?t:0}get length(){return this.end-this.offset}get end(){var e,t;return(t=(e=this.lastNonHiddenNode)===null||e===void 0?void 0:e.end)!==null&&t!==void 0?t:0}get range(){const e=this.firstNonHiddenNode,t=this.lastNonHiddenNode;if(e&&t){if(this._rangeCache===void 0){const{range:r}=e,{range:s}=t;this._rangeCache={start:r.start,end:s.end.line<r.start.line?r.start:s.end}}return this._rangeCache}else return{start:g.create(0,0),end:g.create(0,0)}}get firstNonHiddenNode(){for(const e of this.content)if(!e.hidden)return e;return this.content[0]}get lastNonHiddenNode(){for(let e=this.content.length-1;e>=0;e--){const t=this.content[e];if(!t.hidden)return t}return this.content[this.content.length-1]}}class $e extends Array{constructor(e){super(),this.parent=e,Object.setPrototypeOf(this,$e.prototype)}push(...e){return this.addParents(e),super.push(...e)}unshift(...e){return this.addParents(e),super.unshift(...e)}splice(e,t,...r){return this.addParents(r),super.splice(e,t,...r)}addParents(e){for(const t of e)t.container=this.parent}}class er extends Ce{get text(){return this._text.substring(this.offset,this.end)}get fullText(){return this._text}constructor(e){super(),this._text="",this._text=e??""}}const Se=Symbol("Datatype");function de(n){return n.$type===Se}const We="​",tr=n=>n.endsWith(We)?n:n+We;class rr{constructor(e){this._unorderedGroups=new Map,this.lexer=e.parser.Lexer;const t=this.lexer.definition;this.wrapper=new Fn(t,Object.assign(Object.assign({},e.parser.ParserConfig),{errorMessageProvider:e.parser.ParserErrorMessageProvider}))}alternatives(e,t){this.wrapper.wrapOr(e,t)}optional(e,t){this.wrapper.wrapOption(e,t)}many(e,t){this.wrapper.wrapMany(e,t)}atLeastOne(e,t){this.wrapper.wrapAtLeastOne(e,t)}isRecording(){return this.wrapper.IS_RECORDING}get unorderedGroups(){return this._unorderedGroups}getRuleStack(){return this.wrapper.RULE_STACK}finalize(){this.wrapper.wrapSelfAnalysis()}}class Mn extends rr{get current(){return this.stack[this.stack.length-1]}constructor(e){super(e),this.nodeBuilder=new In,this.stack=[],this.assignmentMap=new Map,this.linker=e.references.Linker,this.converter=e.parser.ValueConverter,this.astReflection=e.shared.AstReflection}rule(e,t){const r=e.fragment?void 0:Ee(e)?Se:ie(e),s=this.wrapper.DEFINE_RULE(tr(e.name),this.startImplementation(r,t).bind(this));return e.entry&&(this.mainRule=s),s}parse(e){this.nodeBuilder.buildRootNode(e);const t=this.lexer.tokenize(e);this.wrapper.input=t.tokens;const r=this.mainRule.call(this.wrapper,{});return this.nodeBuilder.addHiddenTokens(t.hidden),this.unorderedGroups.clear(),{value:r,lexerErrors:t.errors,parserErrors:this.wrapper.errors}}startImplementation(e,t){return r=>{if(!this.isRecording()){const i={$type:e};this.stack.push(i),e===Se&&(i.value="")}let s;try{s=t(r)}catch{s=void 0}return!this.isRecording()&&s===void 0&&(s=this.construct()),s}}consume(e,t,r){const s=this.wrapper.wrapConsume(e,t);if(!this.isRecording()&&this.isValidToken(s)){const i=this.nodeBuilder.buildLeafNode(s,r),{assignment:a,isCrossRef:o}=this.getAssignment(r),c=this.current;if(a){const u=_(r)?s.image:this.converter.convert(s.image,i);this.assign(a.operator,a.feature,u,i,o)}else if(de(c)){let u=s.image;_(r)||(u=this.converter.convert(u,i).toString()),c.value+=u}}}isValidToken(e){return!e.isInsertedInRecovery&&!isNaN(e.startOffset)&&typeof e.endOffset=="number"&&!isNaN(e.endOffset)}subrule(e,t,r,s){let i;this.isRecording()||(i=this.nodeBuilder.buildCompositeNode(r));const a=this.wrapper.wrapSubrule(e,t,s);!this.isRecording()&&i&&i.length>0&&this.performSubruleAssignment(a,r,i)}performSubruleAssignment(e,t,r){const{assignment:s,isCrossRef:i}=this.getAssignment(t);if(s)this.assign(s.operator,s.feature,e,r,i);else if(!s){const a=this.current;if(de(a))a.value+=e.toString();else if(typeof e=="object"&&e){const o=e.$type,c=this.assignWithoutOverride(e,a);o&&(c.$type=o);const u=c;this.stack.pop(),this.stack.push(u)}}}action(e,t){if(!this.isRecording()){let r=this.current;if(!r.$cstNode&&t.feature&&t.operator){r=this.construct(!1);const i=r.$cstNode.feature;this.nodeBuilder.buildCompositeNode(i)}const s={$type:e};this.stack.pop(),this.stack.push(s),t.feature&&t.operator&&this.assign(t.operator,t.feature,r,r.$cstNode,!1)}}construct(e=!0){if(this.isRecording())return;const t=this.current;return cn(t),this.nodeBuilder.construct(t),e&&this.stack.pop(),de(t)?this.converter.convert(t.value,t.$cstNode):(ln(this.astReflection,t),t)}getAssignment(e){if(!this.assignmentMap.has(e)){const t=ne(e,M);this.assignmentMap.set(e,{assignment:t,isCrossRef:t?Re(t.terminal):!1})}return this.assignmentMap.get(e)}assign(e,t,r,s,i){const a=this.current;let o;switch(i&&typeof r=="string"?o=this.linker.buildReference(a,t,s,r):o=r,e){case"=":{a[t]=o;break}case"?=":{a[t]=!0;break}case"+=":Array.isArray(a[t])||(a[t]=[]),a[t].push(o)}}assignWithoutOverride(e,t){for(const[r,s]of Object.entries(t)){const i=e[r];i===void 0?e[r]=s:Array.isArray(i)&&Array.isArray(s)&&(s.push(...i),e[r]=s)}return e}get definitionErrors(){return this.wrapper.definitionErrors}}class _n{buildMismatchTokenMessage(e){return K.buildMismatchTokenMessage(e)}buildNotAllInputParsedMessage(e){return K.buildNotAllInputParsedMessage(e)}buildNoViableAltMessage(e){return K.buildNoViableAltMessage(e)}buildEarlyExitMessage(e){return K.buildEarlyExitMessage(e)}}class nr extends _n{buildMismatchTokenMessage({expected:e,actual:t}){return`Expecting ${e.LABEL?"`"+e.LABEL+"`":e.name.endsWith(":KW")?`keyword '${e.name.substring(0,e.name.length-3)}'`:`token of type '${e.name}'`} but found \`${t.image}\`.`}buildNotAllInputParsedMessage({firstRedundant:e}){return`Expecting end of file but found \`${e.image}\`.`}}class On extends rr{constructor(){super(...arguments),this.tokens=[],this.elementStack=[],this.lastElementStack=[],this.nextTokenIndex=0,this.stackSize=0}action(){}construct(){}parse(e){this.resetState();const t=this.lexer.tokenize(e);return this.tokens=t.tokens,this.wrapper.input=[...this.tokens],this.mainRule.call(this.wrapper,{}),this.unorderedGroups.clear(),{tokens:this.tokens,elementStack:[...this.lastElementStack],tokenIndex:this.nextTokenIndex}}rule(e,t){const r=this.wrapper.DEFINE_RULE(tr(e.name),this.startImplementation(t).bind(this));return e.entry&&(this.mainRule=r),r}resetState(){this.elementStack=[],this.lastElementStack=[],this.nextTokenIndex=0,this.stackSize=0}startImplementation(e){return t=>{const r=this.keepStackSize();try{e(t)}finally{this.resetStackSize(r)}}}removeUnexpectedElements(){this.elementStack.splice(this.stackSize)}keepStackSize(){const e=this.elementStack.length;return this.stackSize=e,e}resetStackSize(e){this.removeUnexpectedElements(),this.stackSize=e}consume(e,t,r){this.wrapper.wrapConsume(e,t),this.isRecording()||(this.lastElementStack=[...this.elementStack,r],this.nextTokenIndex=this.currIdx+1)}subrule(e,t,r,s){this.before(r),this.wrapper.wrapSubrule(e,t,s),this.after(r)}before(e){this.isRecording()||this.elementStack.push(e)}after(e){if(!this.isRecording()){const t=this.elementStack.lastIndexOf(e);t>=0&&this.elementStack.splice(t)}}get currIdx(){return this.wrapper.currIdx}}const Gn={recoveryEnabled:!0,nodeLocationTracking:"full",skipValidations:!0,errorMessageProvider:new nr};class Fn extends yr{constructor(e,t){const r=t&&"maxLookahead"in t;super(e,Object.assign(Object.assign(Object.assign({},Gn),{lookaheadStrategy:r?new vr({maxLookahead:t.maxLookahead}):new Sr}),t))}get IS_RECORDING(){return this.RECORDING_PHASE}DEFINE_RULE(e,t){return this.RULE(e,t)}wrapSelfAnalysis(){this.performSelfAnalysis()}wrapConsume(e,t){return this.consume(e,t)}wrapSubrule(e,t,r){return this.subrule(e,t,{ARGS:[r]})}wrapOr(e,t){this.or(e,t)}wrapOption(e,t){this.option(e,t)}wrapMany(e,t){this.many(e,t)}wrapAtLeastOne(e,t){this.atLeastOne(e,t)}}function sr(n,e,t){return Bn({parser:e,tokens:t,rules:new Map,ruleNames:new Map},n),e}function Bn(n,e){const t=Kt(e,!1),r=y(e.rules).filter(b).filter(s=>t.has(s));for(const s of r){const i=Object.assign(Object.assign({},n),{consume:1,optional:1,subrule:1,many:1,or:1});i.rules.set(s.name,n.parser.rule(s,G(i,s.definition)))}}function G(n,e,t=!1){let r;if(_(e))r=Jn(n,e);else if(re(e))r=Un(n,e);else if(M(e))r=G(n,e.terminal);else if(Re(e))r=ir(n,e);else if(O(e))r=jn(n,e);else if(Tt(e))r=zn(n,e);else if(Bt(e))r=Wn(n,e);else if(Te(e))r=Kn(n,e);else if(Zr(e)){const s=n.consume++;r=()=>n.parser.consume(s,wr,e)}else throw new ut(e.$cstNode,`Unexpected element type: ${e.$type}`);return ar(n,t?void 0:Q(e),r,e.cardinality)}function Un(n,e){const t=ie(e);return()=>n.parser.action(t,e)}function jn(n,e){const t=e.rule.ref;if(b(t)){const r=n.subrule++,s=e.arguments.length>0?Vn(t,e.arguments):()=>({});return i=>n.parser.subrule(r,or(n,t),e,s(i))}else if(F(t)){const r=n.consume++,s=ke(n,t.name);return()=>n.parser.consume(r,s,e)}else if(t)te();else throw new ut(e.$cstNode,`Undefined rule type: ${e.$type}`)}function Vn(n,e){const t=e.map(r=>E(r.value));return r=>{const s={};for(let i=0;i<t.length;i++){const a=n.parameters[i],o=t[i];s[a.name]=o(r)}return s}}function E(n){if(Br(n)){const e=E(n.left),t=E(n.right);return r=>e(r)||t(r)}else if(Fr(n)){const e=E(n.left),t=E(n.right);return r=>e(r)&&t(r)}else if(jr(n)){const e=E(n.value);return t=>!e(t)}else if(Wr(n)){const e=n.parameter.ref.name;return t=>t!==void 0&&t[e]===!0}else if(Gr(n)){const e=!!n.true;return()=>e}te()}function zn(n,e){if(e.elements.length===1)return G(n,e.elements[0]);{const t=[];for(const s of e.elements){const i={ALT:G(n,s,!0)},a=Q(s);a&&(i.GATE=E(a)),t.push(i)}const r=n.or++;return s=>n.parser.alternatives(r,t.map(i=>{const a={ALT:()=>i.ALT(s)},o=i.GATE;return o&&(a.GATE=()=>o(s)),a}))}}function Wn(n,e){if(e.elements.length===1)return G(n,e.elements[0]);const t=[];for(const o of e.elements){const c={ALT:G(n,o,!0)},u=Q(o);u&&(c.GATE=E(u)),t.push(c)}const r=n.or++,s=(o,c)=>{const u=c.getRuleStack().join("-");return`uGroup_${o}_${u}`},i=o=>n.parser.alternatives(r,t.map((c,u)=>{const l={ALT:()=>!0},d=n.parser;l.ALT=()=>{if(c.ALT(o),!d.isRecording()){const h=s(r,d);d.unorderedGroups.get(h)||d.unorderedGroups.set(h,[]);const k=d.unorderedGroups.get(h);typeof(k==null?void 0:k[u])>"u"&&(k[u]=!0)}};const f=c.GATE;return f?l.GATE=()=>f(o):l.GATE=()=>{const h=d.unorderedGroups.get(s(r,d));return!(h!=null&&h[u])},l})),a=ar(n,Q(e),i,"*");return o=>{a(o),n.parser.isRecording()||n.parser.unorderedGroups.delete(s(r,n.parser))}}function Kn(n,e){const t=e.elements.map(r=>G(n,r));return r=>t.forEach(s=>s(r))}function Q(n){if(Te(n))return n.guardCondition}function ir(n,e,t=e.terminal){if(t)if(O(t)&&b(t.rule.ref)){const r=n.subrule++;return s=>n.parser.subrule(r,or(n,t.rule.ref),e,s)}else if(O(t)&&F(t.rule.ref)){const r=n.consume++,s=ke(n,t.rule.ref.name);return()=>n.parser.consume(r,s,e)}else if(_(t)){const r=n.consume++,s=ke(n,t.value);return()=>n.parser.consume(r,s,e)}else throw new Error("Could not build cross reference parser");else{if(!e.type.ref)throw new Error("Could not resolve reference to type: "+e.type.$refText);const r=qt(e.type.ref),s=r==null?void 0:r.terminal;if(!s)throw new Error("Could not find name assignment for type: "+ie(e.type.ref));return ir(n,e,s)}}function Jn(n,e){const t=n.consume++,r=n.tokens[e.value];if(!r)throw new Error("Could not find token for keyword: "+e.value);return()=>n.parser.consume(t,r,e)}function ar(n,e,t,r){const s=e&&E(e);if(!r)if(s){const i=n.or++;return a=>n.parser.alternatives(i,[{ALT:()=>t(a),GATE:()=>s(a)},{ALT:Fe(),GATE:()=>!s(a)}])}else return t;if(r==="*"){const i=n.many++;return a=>n.parser.many(i,{DEF:()=>t(a),GATE:s?()=>s(a):void 0})}else if(r==="+"){const i=n.many++;if(s){const a=n.or++;return o=>n.parser.alternatives(a,[{ALT:()=>n.parser.atLeastOne(i,{DEF:()=>t(o)}),GATE:()=>s(o)},{ALT:Fe(),GATE:()=>!s(o)}])}else return a=>n.parser.atLeastOne(i,{DEF:()=>t(a)})}else if(r==="?"){const i=n.optional++;return a=>n.parser.optional(i,{DEF:()=>t(a),GATE:s?()=>s(a):void 0})}else te()}function or(n,e){const t=Hn(n,e),r=n.rules.get(t);if(!r)throw new Error(`Rule "${t}" not found."`);return r}function Hn(n,e){if(b(e))return e.name;if(n.ruleNames.has(e))return n.ruleNames.get(e);{let t=e,r=t.$container,s=e.$type;for(;!b(r);)(Te(r)||Tt(r)||Bt(r))&&(s=r.elements.indexOf(t).toString()+":"+s),t=r,r=r.$container;return s=r.name+":"+s,n.ruleNames.set(e,s),s}}function ke(n,e){const t=n.tokens[e];if(!t)throw new Error(`Token "${e}" not found."`);return t}function qn(n){const e=n.Grammar,t=n.parser.Lexer,r=new On(n);return sr(e,r,t.definition),r.finalize(),r}function Qn(n){const e=Yn(n);return e.finalize(),e}function Yn(n){const e=n.Grammar,t=n.parser.Lexer,r=new Mn(n);return sr(e,r,t.definition)}class Xn{buildTokens(e,t){const r=y(Kt(e,!1)),s=this.buildTerminalTokens(r),i=this.buildKeywordTokens(r,s,t);return s.forEach(a=>{const o=a.PATTERN;typeof o=="object"&&o&&"test"in o&&ze(o)?i.unshift(a):i.push(a)}),i}buildTerminalTokens(e){return e.filter(F).filter(t=>!t.fragment).map(t=>this.buildTerminalToken(t)).toArray()}buildTerminalToken(e){const t=Pe(e),r=this.requiresCustomPattern(t)?this.regexPatternFunction(t):t,s={name:e.name,PATTERN:r,LINE_BREAKS:!0};return e.hidden&&(s.GROUP=ze(t)?at.SKIPPED:"hidden"),s}requiresCustomPattern(e){return e.flags.includes("u")?!0:!!(e.source.includes("?<=")||e.source.includes("?<!"))}regexPatternFunction(e){const t=new RegExp(e,e.flags+"y");return(r,s)=>(t.lastIndex=s,t.exec(r))}buildKeywordTokens(e,t,r){return e.filter(b).flatMap(s=>W(s).filter(_)).distinct(s=>s.value).toArray().sort((s,i)=>i.value.length-s.value.length).map(s=>this.buildKeywordToken(s,t,!!(r!=null&&r.caseInsensitive)))}buildKeywordToken(e,t,r){return{name:e.value,PATTERN:this.buildKeywordPattern(e,r),LONGER_ALT:this.findLongerAlt(e,t)}}buildKeywordPattern(e,t){return t?new RegExp(pn(e.value)):e.value}findLongerAlt(e,t){return t.reduce((r,s)=>{const i=s==null?void 0:s.PATTERN;return i!=null&&i.source&&gn("^"+i.source+"$",e.value)&&r.push(s),r},[])}}class Zn{convert(e,t){let r=t.grammarSource;if(Re(r)&&(r=Sn(r)),O(r)){const s=r.rule.ref;if(!s)throw new Error("This cst node was not parsed by a rule.");return this.runConverter(s,e,t)}return e}runConverter(e,t,r){var s;switch(e.name.toUpperCase()){case"INT":return A.convertInt(t);case"STRING":return A.convertString(t);case"ID":return A.convertID(t)}switch((s=Dn(e))===null||s===void 0?void 0:s.toLowerCase()){case"number":return A.convertNumber(t);case"boolean":return A.convertBoolean(t);case"bigint":return A.convertBigint(t);case"date":return A.convertDate(t);default:return t}}}var A;(function(n){function e(u){let l="";for(let d=1;d<u.length-1;d++){const f=u.charAt(d);if(f==="\\"){const h=u.charAt(++d);l+=t(h)}else l+=f}return l}n.convertString=e;function t(u){switch(u){case"b":return"\b";case"f":return"\f";case"n":return`
`;case"r":return"\r";case"t":return"	";case"v":return"\v";case"0":return"\0";default:return u}}function r(u){return u.charAt(0)==="^"?u.substring(1):u}n.convertID=r;function s(u){return parseInt(u)}n.convertInt=s;function i(u){return BigInt(u)}n.convertBigint=i;function a(u){return new Date(u)}n.convertDate=a;function o(u){return Number(u)}n.convertNumber=o;function c(u){return u.toLowerCase()==="true"}n.convertBoolean=c})(A||(A={}));function es(){return new Promise(n=>{typeof setImmediate>"u"?setTimeout(n,0):setImmediate(n)})}let Ke=0,ts=10;const Y=Symbol("OperationCancelled");function Ie(n){return n===Y}async function R(n){if(n===S.None)return;const e=Date.now();if(e-Ke>=ts&&(Ke=e,await es()),n.isCancellationRequested)throw Y}class Me{constructor(){this.promise=new Promise((e,t)=>{this.resolve=r=>(e(r),this),this.reject=r=>(t(r),this)})}}var $;(function(n){n.basename=z.basename,n.dirname=z.dirname,n.extname=z.extname,n.joinPath=z.joinPath,n.resolvePath=z.resolvePath;function e(r,s){return(r==null?void 0:r.toString())===(s==null?void 0:s.toString())}n.equals=e;function t(r,s){const i=typeof r=="string"?r:r.path,a=typeof s=="string"?s:s.path,o=i.split("/").filter(f=>f.length>0),c=a.split("/").filter(f=>f.length>0);let u=0;for(;u<o.length&&o[u]===c[u];u++);const l="../".repeat(o.length-u),d=c.slice(u).join("/");return l+d}n.relative=t})($||($={}));var p;(function(n){n[n.Changed=0]="Changed",n[n.Parsed=1]="Parsed",n[n.IndexedContent=2]="IndexedContent",n[n.ComputedScopes=3]="ComputedScopes",n[n.Linked=4]="Linked",n[n.IndexedReferences=5]="IndexedReferences",n[n.Validated=6]="Validated"})(p||(p={}));class rs{constructor(e){this.serviceRegistry=e.ServiceRegistry,this.textDocuments=e.workspace.TextDocuments,this.fileSystemProvider=e.workspace.FileSystemProvider}async fromUri(e,t=S.None){const r=await this.fileSystemProvider.readFile(e);return this.createAsync(e,r,t)}fromTextDocument(e,t,r){return t=t??U.parse(e.uri),r?this.createAsync(t,e,r):this.create(t,e)}fromString(e,t,r){return r?this.createAsync(t,e,r):this.create(t,e)}fromModel(e,t){return this.create(t,{$model:e})}create(e,t){if(typeof t=="string"){const r=this.parse(e,t);return this.createLangiumDocument(r,e,void 0,t)}else if("$model"in t){const r={value:t.$model,parserErrors:[],lexerErrors:[]};return this.createLangiumDocument(r,e)}else{const r=this.parse(e,t.getText());return this.createLangiumDocument(r,e,t)}}async createAsync(e,t,r){if(typeof t=="string"){const s=await this.parseAsync(e,t,r);return this.createLangiumDocument(s,e,void 0,t)}else{const s=await this.parseAsync(e,t.getText(),r);return this.createLangiumDocument(s,e,t)}}createLangiumDocument(e,t,r,s){let i;if(r)i={parseResult:e,uri:t,state:p.Parsed,references:[],textDocument:r};else{const a=this.createTextDocumentGetter(t,s);i={parseResult:e,uri:t,state:p.Parsed,references:[],get textDocument(){return a()}}}return e.value.$document=i,i}async update(e,t){var r,s;const i=(r=e.parseResult.value.$cstNode)===null||r===void 0?void 0:r.root.fullText,a=(s=this.textDocuments)===null||s===void 0?void 0:s.get(e.uri.toString()),o=a?a.getText():await this.fileSystemProvider.readFile(e.uri);if(a)Object.defineProperty(e,"textDocument",{value:a});else{const c=this.createTextDocumentGetter(e.uri,o);Object.defineProperty(e,"textDocument",{get:c})}return i!==o&&(e.parseResult=await this.parseAsync(e.uri,o,t),e.parseResult.value.$document=e),e.state=p.Parsed,e}parse(e,t){return this.serviceRegistry.getServices(e).parser.LangiumParser.parse(t)}parseAsync(e,t,r){return this.serviceRegistry.getServices(e).parser.AsyncParser.parse(t,r)}createTextDocumentGetter(e,t){const r=this.serviceRegistry;let s;return()=>s??(s=Nr.create(e.toString(),r.getServices(e).LanguageMetaData.languageId,0,t??""))}}class ns{constructor(e){this.documentMap=new Map,this.langiumDocumentFactory=e.workspace.LangiumDocumentFactory}get all(){return y(this.documentMap.values())}addDocument(e){const t=e.uri.toString();if(this.documentMap.has(t))throw new Error(`A document with the URI '${t}' is already present.`);this.documentMap.set(t,e)}getDocument(e){const t=e.toString();return this.documentMap.get(t)}async getOrCreateDocument(e,t){let r=this.getDocument(e);return r||(r=await this.langiumDocumentFactory.fromUri(e,t),this.addDocument(r),r)}createDocument(e,t,r){if(r)return this.langiumDocumentFactory.fromString(t,e,r).then(s=>(this.addDocument(s),s));{const s=this.langiumDocumentFactory.fromString(t,e);return this.addDocument(s),s}}hasDocument(e){return this.documentMap.has(e.toString())}invalidateDocument(e){const t=e.toString(),r=this.documentMap.get(t);return r&&(r.state=p.Changed,r.precomputedScopes=void 0,r.references=[],r.diagnostics=void 0),r}deleteDocument(e){const t=e.toString(),r=this.documentMap.get(t);return r&&(r.state=p.Changed,this.documentMap.delete(t)),r}}class ss{constructor(e){this.reflection=e.shared.AstReflection,this.langiumDocuments=()=>e.shared.workspace.LangiumDocuments,this.scopeProvider=e.references.ScopeProvider,this.astNodeLocator=e.workspace.AstNodeLocator}async link(e,t=S.None){for(const r of B(e.parseResult.value))await R(t),zt(r).forEach(s=>this.doLink(s,e))}doLink(e,t){const r=e.reference;if(r._ref===void 0)try{const s=this.getCandidate(e);if(J(s))r._ref=s;else if(r._nodeDescription=s,this.langiumDocuments().hasDocument(s.documentUri)){const i=this.loadAstNode(s);r._ref=i??this.createLinkingError(e,s)}}catch(s){r._ref=Object.assign(Object.assign({},e),{message:`An error occurred while resolving reference to '${r.$refText}': ${s}`})}t.references.push(r)}unlink(e){for(const t of e.references)delete t._ref,delete t._nodeDescription;e.references=[]}getCandidate(e){const r=this.scopeProvider.getScope(e).getElement(e.reference.$refText);return r??this.createLinkingError(e)}buildReference(e,t,r,s){const i=this,a={$refNode:r,$refText:s,get ref(){var o;if(w(this._ref))return this._ref;if(br(this._nodeDescription)){const c=i.loadAstNode(this._nodeDescription);this._ref=c??i.createLinkingError({reference:a,container:e,property:t},this._nodeDescription)}else if(this._ref===void 0){const c=i.getLinkedNode({reference:a,container:e,property:t});if(c.error&&D(e).state<p.ComputedScopes)return;this._ref=(o=c.node)!==null&&o!==void 0?o:c.error,this._nodeDescription=c.descr}return w(this._ref)?this._ref:void 0},get $nodeDescription(){return this._nodeDescription},get error(){return J(this._ref)?this._ref:void 0}};return a}getLinkedNode(e){try{const t=this.getCandidate(e);if(J(t))return{error:t};const r=this.loadAstNode(t);return r?{node:r,descr:t}:{descr:t,error:this.createLinkingError(e,t)}}catch(t){return{error:Object.assign(Object.assign({},e),{message:`An error occurred while resolving reference to '${e.reference.$refText}': ${t}`})}}}loadAstNode(e){if(e.node)return e.node;const t=this.langiumDocuments().getDocument(e.documentUri);if(t)return this.astNodeLocator.getAstNode(t.parseResult.value,e.path)}createLinkingError(e,t){const r=D(e.container);r.state<p.ComputedScopes&&console.warn(`Attempted reference resolution before document reached ComputedScopes state (${r.uri}).`);const s=this.reflection.getReferenceType(e);return Object.assign(Object.assign({},e),{message:`Could not resolve reference to ${s} named '${e.reference.$refText}'.`,targetDescription:t})}}function is(n){return typeof n.name=="string"}class as{getName(e){if(is(e))return e.name}getNameNode(e){return Ht(e.$cstNode,"name")}}class os{constructor(e){this.nameProvider=e.references.NameProvider,this.index=e.shared.workspace.IndexManager,this.nodeLocator=e.workspace.AstNodeLocator}findDeclaration(e){if(e){const t=Rn(e),r=e.astNode;if(t&&r){const s=r[t.feature];if(T(s))return s.ref;if(Array.isArray(s)){for(const i of s)if(T(i)&&i.$refNode&&i.$refNode.offset<=e.offset&&i.$refNode.end>=e.end)return i.ref}}if(r){const s=this.nameProvider.getNameNode(r);if(s&&(s===e||Ar(e,s)))return r}}}findDeclarationNode(e){const t=this.findDeclaration(e);if(t!=null&&t.$cstNode){const r=this.nameProvider.getNameNode(t);return r??t.$cstNode}}findReferences(e,t){const r=[];if(t.includeDeclaration){const i=this.getReferenceToSelf(e);i&&r.push(i)}let s=this.index.findAllReferences(e,this.nodeLocator.getAstNodePath(e));return t.documentUri&&(s=s.filter(i=>$.equals(i.sourceUri,t.documentUri))),r.push(...s),y(r)}getReferenceToSelf(e){const t=this.nameProvider.getNameNode(e);if(t){const r=D(e),s=this.nodeLocator.getAstNodePath(e);return{sourceUri:r.uri,sourcePath:s,targetUri:r.uri,targetPath:s,segment:q(t),local:!0}}}}class _e{constructor(e){if(this.map=new Map,e)for(const[t,r]of e)this.add(t,r)}get size(){return pe.sum(y(this.map.values()).map(e=>e.length))}clear(){this.map.clear()}delete(e,t){if(t===void 0)return this.map.delete(e);{const r=this.map.get(e);if(r){const s=r.indexOf(t);if(s>=0)return r.length===1?this.map.delete(e):r.splice(s,1),!0}return!1}}get(e){var t;return(t=this.map.get(e))!==null&&t!==void 0?t:[]}has(e,t){if(t===void 0)return this.map.has(e);{const r=this.map.get(e);return r?r.indexOf(t)>=0:!1}}add(e,t){return this.map.has(e)?this.map.get(e).push(t):this.map.set(e,[t]),this}addAll(e,t){return this.map.has(e)?this.map.get(e).push(...t):this.map.set(e,Array.from(t)),this}forEach(e){this.map.forEach((t,r)=>t.forEach(s=>e(s,r,this)))}[Symbol.iterator](){return this.entries().iterator()}entries(){return y(this.map.entries()).flatMap(([e,t])=>t.map(r=>[e,r]))}keys(){return y(this.map.keys())}values(){return y(this.map.values()).flat()}entriesGroupedByKey(){return y(this.map.entries())}}class Je{get size(){return this.map.size}constructor(e){if(this.map=new Map,this.inverse=new Map,e)for(const[t,r]of e)this.set(t,r)}clear(){this.map.clear(),this.inverse.clear()}set(e,t){return this.map.set(e,t),this.inverse.set(t,e),this}get(e){return this.map.get(e)}getKey(e){return this.inverse.get(e)}delete(e){const t=this.map.get(e);return t!==void 0?(this.map.delete(e),this.inverse.delete(t),!0):!1}}class cs{constructor(e){this.nameProvider=e.references.NameProvider,this.descriptions=e.workspace.AstNodeDescriptionProvider}async computeExports(e,t=S.None){return this.computeExportsForNode(e.parseResult.value,e,void 0,t)}async computeExportsForNode(e,t,r=De,s=S.None){const i=[];this.exportNode(e,i,t);for(const a of r(e))await R(s),this.exportNode(a,i,t);return i}exportNode(e,t,r){const s=this.nameProvider.getName(e);s&&t.push(this.descriptions.createDescription(e,s,r))}async computeLocalScopes(e,t=S.None){const r=e.parseResult.value,s=new _e;for(const i of W(r))await R(t),this.processNode(i,e,s);return s}processNode(e,t,r){const s=e.$container;if(s){const i=this.nameProvider.getName(e);i&&r.add(s,this.descriptions.createDescription(e,i,t))}}}class He{constructor(e,t,r){var s;this.elements=e,this.outerScope=t,this.caseInsensitive=(s=r==null?void 0:r.caseInsensitive)!==null&&s!==void 0?s:!1}getAllElements(){return this.outerScope?this.elements.concat(this.outerScope.getAllElements()):this.elements}getElement(e){const t=this.caseInsensitive?this.elements.find(r=>r.name.toLowerCase()===e.toLowerCase()):this.elements.find(r=>r.name===e);if(t)return t;if(this.outerScope)return this.outerScope.getElement(e)}}class us{constructor(e,t,r){var s;this.elements=new Map,this.caseInsensitive=(s=r==null?void 0:r.caseInsensitive)!==null&&s!==void 0?s:!1;for(const i of e){const a=this.caseInsensitive?i.name.toLowerCase():i.name;this.elements.set(a,i)}this.outerScope=t}getElement(e){const t=this.caseInsensitive?e.toLowerCase():e,r=this.elements.get(t);if(r)return r;if(this.outerScope)return this.outerScope.getElement(e)}getAllElements(){let e=y(this.elements.values());return this.outerScope&&(e=e.concat(this.outerScope.getAllElements())),e}}class cr{constructor(){this.toDispose=[],this.isDisposed=!1}onDispose(e){this.toDispose.push(e)}dispose(){this.throwIfDisposed(),this.clear(),this.isDisposed=!0,this.toDispose.forEach(e=>e.dispose())}throwIfDisposed(){if(this.isDisposed)throw new Error("This cache has already been disposed")}}class ls extends cr{constructor(){super(...arguments),this.cache=new Map}has(e){return this.throwIfDisposed(),this.cache.has(e)}set(e,t){this.throwIfDisposed(),this.cache.set(e,t)}get(e,t){if(this.throwIfDisposed(),this.cache.has(e))return this.cache.get(e);if(t){const r=t();return this.cache.set(e,r),r}else return}delete(e){return this.throwIfDisposed(),this.cache.delete(e)}clear(){this.throwIfDisposed(),this.cache.clear()}}class ds extends cr{constructor(e){super(),this.cache=new Map,this.converter=e??(t=>t)}has(e,t){return this.throwIfDisposed(),this.cacheForContext(e).has(t)}set(e,t,r){this.throwIfDisposed(),this.cacheForContext(e).set(t,r)}get(e,t,r){this.throwIfDisposed();const s=this.cacheForContext(e);if(s.has(t))return s.get(t);if(r){const i=r();return s.set(t,i),i}else return}delete(e,t){return this.throwIfDisposed(),this.cacheForContext(e).delete(t)}clear(e){if(this.throwIfDisposed(),e){const t=this.converter(e);this.cache.delete(t)}else this.cache.clear()}cacheForContext(e){const t=this.converter(e);let r=this.cache.get(t);return r||(r=new Map,this.cache.set(t,r)),r}}class fs extends ls{constructor(e){super(),this.onDispose(e.workspace.DocumentBuilder.onUpdate(()=>{this.clear()}))}}class hs{constructor(e){this.reflection=e.shared.AstReflection,this.nameProvider=e.references.NameProvider,this.descriptions=e.workspace.AstNodeDescriptionProvider,this.indexManager=e.shared.workspace.IndexManager,this.globalScopeCache=new fs(e.shared)}getScope(e){const t=[],r=this.reflection.getReferenceType(e),s=D(e.container).precomputedScopes;if(s){let a=e.container;do{const o=s.get(a);o.length>0&&t.push(y(o).filter(c=>this.reflection.isSubtype(c.type,r))),a=a.$container}while(a)}let i=this.getGlobalScope(r,e);for(let a=t.length-1;a>=0;a--)i=this.createScope(t[a],i);return i}createScope(e,t,r){return new He(y(e),t,r)}createScopeForNodes(e,t,r){const s=y(e).map(i=>{const a=this.nameProvider.getName(i);if(a)return this.descriptions.createDescription(i,a)}).nonNullable();return new He(s,t,r)}getGlobalScope(e,t){return this.globalScopeCache.get(e,()=>new us(this.indexManager.allElements(e)))}}function ms(n){return typeof n.$comment=="string"}function qe(n){return typeof n=="object"&&!!n&&("$ref"in n||"$error"in n)}class ps{constructor(e){this.ignoreProperties=new Set(["$container","$containerProperty","$containerIndex","$document","$cstNode"]),this.langiumDocuments=e.shared.workspace.LangiumDocuments,this.astNodeLocator=e.workspace.AstNodeLocator,this.nameProvider=e.references.NameProvider,this.commentProvider=e.documentation.CommentProvider}serialize(e,t={}){const r=t==null?void 0:t.replacer,s=(a,o)=>this.replacer(a,o,t),i=r?(a,o)=>r(a,o,s):s;try{return this.currentDocument=D(e),JSON.stringify(e,i,t==null?void 0:t.space)}finally{this.currentDocument=void 0}}deserialize(e,t={}){const r=JSON.parse(e);return this.linkNode(r,r,t),r}replacer(e,t,{refText:r,sourceText:s,textRegions:i,comments:a,uriConverter:o}){var c,u,l,d;if(!this.ignoreProperties.has(e))if(T(t)){const f=t.ref,h=r?t.$refText:void 0;if(f){const k=D(f);let I="";this.currentDocument&&this.currentDocument!==k&&(o?I=o(k.uri,t):I=k.uri.toString());const ae=this.astNodeLocator.getAstNodePath(f);return{$ref:`${I}#${ae}`,$refText:h}}else return{$error:(u=(c=t.error)===null||c===void 0?void 0:c.message)!==null&&u!==void 0?u:"Could not resolve reference",$refText:h}}else if(w(t)){let f;if(i&&(f=this.addAstNodeRegionWithAssignmentsTo(Object.assign({},t)),(!e||t.$document)&&(f!=null&&f.$textRegion)&&(f.$textRegion.documentURI=(l=this.currentDocument)===null||l===void 0?void 0:l.uri.toString())),s&&!e&&(f??(f=Object.assign({},t)),f.$sourceText=(d=t.$cstNode)===null||d===void 0?void 0:d.text),a){f??(f=Object.assign({},t));const h=this.commentProvider.getComment(t);h&&(f.$comment=h.replace(/\r/g,""))}return f??t}else return t}addAstNodeRegionWithAssignmentsTo(e){const t=r=>({offset:r.offset,end:r.end,length:r.length,range:r.range});if(e.$cstNode){const r=e.$textRegion=t(e.$cstNode),s=r.assignments={};return Object.keys(e).filter(i=>!i.startsWith("$")).forEach(i=>{const a=xn(e.$cstNode,i).map(t);a.length!==0&&(s[i]=a)}),e}}linkNode(e,t,r,s,i,a){for(const[c,u]of Object.entries(e))if(Array.isArray(u))for(let l=0;l<u.length;l++){const d=u[l];qe(d)?u[l]=this.reviveReference(e,c,t,d,r):w(d)&&this.linkNode(d,t,r,e,c,l)}else qe(u)?e[c]=this.reviveReference(e,c,t,u,r):w(u)&&this.linkNode(u,t,r,e,c);const o=e;o.$container=s,o.$containerProperty=i,o.$containerIndex=a}reviveReference(e,t,r,s,i){let a=s.$refText,o=s.$error;if(s.$ref){const c=this.getRefNode(r,s.$ref,i.uriConverter);if(w(c))return a||(a=this.nameProvider.getName(c)),{$refText:a??"",ref:c};o=c}if(o){const c={$refText:a??""};return c.error={container:e,property:t,message:o,reference:c},c}else return}getRefNode(e,t,r){try{const s=t.indexOf("#");if(s===0){const c=this.astNodeLocator.getAstNode(e,t.substring(1));return c||"Could not resolve path: "+t}if(s<0){const c=r?r(t):U.parse(t),u=this.langiumDocuments.getDocument(c);return u?u.parseResult.value:"Could not find document for URI: "+t}const i=r?r(t.substring(0,s)):U.parse(t.substring(0,s)),a=this.langiumDocuments.getDocument(i);if(!a)return"Could not find document for URI: "+t;if(s===t.length-1)return a.parseResult.value;const o=this.astNodeLocator.getAstNode(a.parseResult.value,t.substring(s+1));return o||"Could not resolve URI: "+t}catch(s){return String(s)}}}class gs{register(e){if(!this.singleton&&!this.map){this.singleton=e;return}if(!this.map&&(this.map={},this.singleton)){for(const t of this.singleton.LanguageMetaData.fileExtensions)this.map[t]=this.singleton;this.singleton=void 0}for(const t of e.LanguageMetaData.fileExtensions)this.map[t]!==void 0&&this.map[t]!==e&&console.warn(`The file extension ${t} is used by multiple languages. It is now assigned to '${e.LanguageMetaData.languageId}'.`),this.map[t]=e}getServices(e){if(this.singleton!==void 0)return this.singleton;if(this.map===void 0)throw new Error("The service registry is empty. Use `register` to register the services of a language.");const t=$.extname(e),r=this.map[t];if(!r)throw new Error(`The service registry contains no services for the extension '${t}'.`);return r}get all(){return this.singleton!==void 0?[this.singleton]:this.map!==void 0?Object.values(this.map):[]}}function Qe(n){return{code:n}}var X;(function(n){n.all=["fast","slow","built-in"]})(X||(X={}));class ys{constructor(e){this.entries=new _e,this.reflection=e.shared.AstReflection}register(e,t=this,r="fast"){if(r==="built-in")throw new Error("The 'built-in' category is reserved for lexer, parser, and linker errors.");for(const[s,i]of Object.entries(e)){const a=i;if(Array.isArray(a))for(const o of a){const c={check:this.wrapValidationException(o,t),category:r};this.addEntry(s,c)}else if(typeof a=="function"){const o={check:this.wrapValidationException(a,t),category:r};this.addEntry(s,o)}}}wrapValidationException(e,t){return async(r,s,i)=>{try{await e.call(t,r,s,i)}catch(a){if(Ie(a))throw a;console.error("An error occurred during validation:",a);const o=a instanceof Error?a.message:String(a);a instanceof Error&&a.stack&&console.error(a.stack),s("error","An error occurred during validation: "+o,{node:r})}}}addEntry(e,t){if(e==="AstNode"){this.entries.add("AstNode",t);return}for(const r of this.reflection.getAllSubTypes(e))this.entries.add(r,t)}getChecks(e,t){let r=y(this.entries.get(e)).concat(this.entries.get("AstNode"));return t&&(r=r.filter(s=>t.includes(s.category))),r.map(s=>s.check)}}class vs{constructor(e){this.validationRegistry=e.validation.ValidationRegistry,this.metadata=e.LanguageMetaData}async validateDocument(e,t={},r=S.None){const s=e.parseResult,i=[];if(await R(r),(!t.categories||t.categories.includes("built-in"))&&(this.processLexingErrors(s,i,t),t.stopAfterLexingErrors&&i.some(a=>{var o;return((o=a.data)===null||o===void 0?void 0:o.code)===L.LexingError})||(this.processParsingErrors(s,i,t),t.stopAfterParsingErrors&&i.some(a=>{var o;return((o=a.data)===null||o===void 0?void 0:o.code)===L.ParsingError}))||(this.processLinkingErrors(e,i,t),t.stopAfterLinkingErrors&&i.some(a=>{var o;return((o=a.data)===null||o===void 0?void 0:o.code)===L.LinkingError}))))return i;try{i.push(...await this.validateAst(s.value,t,r))}catch(a){if(Ie(a))throw a;console.error("An error occurred during validation:",a)}return await R(r),i}processLexingErrors(e,t,r){for(const s of e.lexerErrors){const i={severity:fe("error"),range:{start:{line:s.line-1,character:s.column-1},end:{line:s.line-1,character:s.column+s.length-1}},message:s.message,data:Qe(L.LexingError),source:this.getSource()};t.push(i)}}processParsingErrors(e,t,r){for(const s of e.parserErrors){let i;if(isNaN(s.token.startOffset)){if("previousToken"in s){const a=s.previousToken;if(isNaN(a.startOffset)){const o={line:0,character:0};i={start:o,end:o}}else{const o={line:a.endLine-1,character:a.endColumn};i={start:o,end:o}}}}else i=ye(s.token);if(i){const a={severity:fe("error"),range:i,message:s.message,data:Qe(L.ParsingError),source:this.getSource()};t.push(a)}}}processLinkingErrors(e,t,r){for(const s of e.references){const i=s.error;if(i){const a={node:i.container,property:i.property,index:i.index,data:{code:L.LinkingError,containerType:i.container.$type,property:i.property,refText:i.reference.$refText}};t.push(this.toDiagnostic("error",i.message,a))}}}async validateAst(e,t,r=S.None){const s=[],i=(a,o,c)=>{s.push(this.toDiagnostic(a,o,c))};return await Promise.all(B(e).map(async a=>{await R(r);const o=this.validationRegistry.getChecks(a.$type,t.categories);for(const c of o)await c(a,i,r)})),s}toDiagnostic(e,t,r){return{message:t,range:ws(r),severity:fe(e),code:r.code,codeDescription:r.codeDescription,tags:r.tags,relatedInformation:r.relatedInformation,data:r.data,source:this.getSource()}}getSource(){return this.metadata.languageId}}function ws(n){if(n.range)return n.range;let e;return typeof n.property=="string"?e=Ht(n.node.$cstNode,n.property,n.index):typeof n.keyword=="string"&&(e=Nn(n.node.$cstNode,n.keyword,n.index)),e??(e=n.node.$cstNode),e?e.range:{start:{line:0,character:0},end:{line:0,character:0}}}function fe(n){switch(n){case"error":return 1;case"warning":return 2;case"info":return 3;case"hint":return 4;default:throw new Error("Invalid diagnostic severity: "+n)}}var L;(function(n){n.LexingError="lexing-error",n.ParsingError="parsing-error",n.LinkingError="linking-error"})(L||(L={}));class Ss{constructor(e){this.astNodeLocator=e.workspace.AstNodeLocator,this.nameProvider=e.references.NameProvider}createDescription(e,t,r=D(e)){t??(t=this.nameProvider.getName(e));const s=this.astNodeLocator.getAstNodePath(e);if(!t)throw new Error(`Node at path ${s} has no name.`);let i;const a=()=>{var o;return i??(i=q((o=this.nameProvider.getNameNode(e))!==null&&o!==void 0?o:e.$cstNode))};return{node:e,name:t,get nameSegment(){return a()},selectionSegment:q(e.$cstNode),type:e.$type,documentUri:r.uri,path:s}}}class ks{constructor(e){this.nodeLocator=e.workspace.AstNodeLocator}async createDescriptions(e,t=S.None){const r=[],s=e.parseResult.value;for(const i of B(s))await R(t),zt(i).filter(a=>!J(a)).forEach(a=>{const o=this.createDescription(a);o&&r.push(o)});return r}createDescription(e){const t=e.reference.$nodeDescription,r=e.reference.$refNode;if(!t||!r)return;const s=D(e.container).uri;return{sourceUri:s,sourcePath:this.nodeLocator.getAstNodePath(e.container),targetUri:t.documentUri,targetPath:t.path,segment:q(r),local:$.equals(t.documentUri,s)}}}class xs{constructor(){this.segmentSeparator="/",this.indexSeparator="@"}getAstNodePath(e){if(e.$container){const t=this.getAstNodePath(e.$container),r=this.getPathSegment(e);return t+this.segmentSeparator+r}return""}getPathSegment({$containerProperty:e,$containerIndex:t}){if(!e)throw new Error("Missing '$containerProperty' in AST node.");return t!==void 0?e+this.indexSeparator+t:e}getAstNode(e,t){return t.split(this.segmentSeparator).reduce((s,i)=>{if(!s||i.length===0)return s;const a=i.indexOf(this.indexSeparator);if(a>0){const o=i.substring(0,a),c=parseInt(i.substring(a+1)),u=s[o];return u==null?void 0:u[c]}return s[i]},e)}}class Ns{constructor(e){this._ready=new Me,this.settings={},this.workspaceConfig=!1,this.serviceRegistry=e.ServiceRegistry}get ready(){return this._ready.promise}initialize(e){var t,r;this.workspaceConfig=(r=(t=e.capabilities.workspace)===null||t===void 0?void 0:t.configuration)!==null&&r!==void 0?r:!1}async initialized(e){if(this.workspaceConfig){if(e.register){const t=this.serviceRegistry.all;e.register({section:t.map(r=>this.toSectionName(r.LanguageMetaData.languageId))})}if(e.fetchConfiguration){const t=this.serviceRegistry.all.map(s=>({section:this.toSectionName(s.LanguageMetaData.languageId)})),r=await e.fetchConfiguration(t);t.forEach((s,i)=>{this.updateSectionConfiguration(s.section,r[i])})}}this._ready.resolve()}updateConfiguration(e){e.settings&&Object.keys(e.settings).forEach(t=>{this.updateSectionConfiguration(t,e.settings[t])})}updateSectionConfiguration(e,t){this.settings[e]=t}async getConfiguration(e,t){await this.ready;const r=this.toSectionName(e);if(this.settings[r])return this.settings[r][t]}toSectionName(e){return`${e}`}}var Z;(function(n){function e(t){return{dispose:async()=>await t()}}n.create=e})(Z||(Z={}));class bs{constructor(e){this.updateBuildOptions={validation:{categories:["built-in","fast"]}},this.updateListeners=[],this.buildPhaseListeners=new _e,this.buildState=new Map,this.documentBuildWaiters=new Map,this.currentState=p.Changed,this.langiumDocuments=e.workspace.LangiumDocuments,this.langiumDocumentFactory=e.workspace.LangiumDocumentFactory,this.indexManager=e.workspace.IndexManager,this.serviceRegistry=e.ServiceRegistry}async build(e,t={},r=S.None){var s,i;for(const a of e){const o=a.uri.toString();if(a.state===p.Validated){if(typeof t.validation=="boolean"&&t.validation)a.state=p.IndexedReferences,a.diagnostics=void 0,this.buildState.delete(o);else if(typeof t.validation=="object"){const c=this.buildState.get(o),u=(s=c==null?void 0:c.result)===null||s===void 0?void 0:s.validationChecks;if(u){const d=((i=t.validation.categories)!==null&&i!==void 0?i:X.all).filter(f=>!u.includes(f));d.length>0&&(this.buildState.set(o,{completed:!1,options:{validation:Object.assign(Object.assign({},t.validation),{categories:d})},result:c.result}),a.state=p.IndexedReferences)}}}else this.buildState.delete(o)}this.currentState=p.Changed,await this.emitUpdate(e.map(a=>a.uri),[]),await this.buildDocuments(e,t,r)}async update(e,t,r=S.None){this.currentState=p.Changed;for(const a of t)this.langiumDocuments.deleteDocument(a),this.buildState.delete(a.toString()),this.indexManager.remove(a);for(const a of e){if(!this.langiumDocuments.invalidateDocument(a)){const c=this.langiumDocumentFactory.fromModel({$type:"INVALID"},a);c.state=p.Changed,this.langiumDocuments.addDocument(c)}this.buildState.delete(a.toString())}const s=y(e).concat(t).map(a=>a.toString()).toSet();this.langiumDocuments.all.filter(a=>!s.has(a.uri.toString())&&this.shouldRelink(a,s)).forEach(a=>{this.serviceRegistry.getServices(a.uri).references.Linker.unlink(a),a.state=Math.min(a.state,p.ComputedScopes),a.diagnostics=void 0}),await this.emitUpdate(e,t),await R(r);const i=this.langiumDocuments.all.filter(a=>{var o;return a.state<p.Linked||!(!((o=this.buildState.get(a.uri.toString()))===null||o===void 0)&&o.completed)}).toArray();await this.buildDocuments(i,this.updateBuildOptions,r)}async emitUpdate(e,t){await Promise.all(this.updateListeners.map(r=>r(e,t)))}shouldRelink(e,t){return e.references.some(r=>r.error!==void 0)?!0:this.indexManager.isAffected(e,t)}onUpdate(e){return this.updateListeners.push(e),Z.create(()=>{const t=this.updateListeners.indexOf(e);t>=0&&this.updateListeners.splice(t,1)})}async buildDocuments(e,t,r){this.prepareBuild(e,t),await this.runCancelable(e,p.Parsed,r,i=>this.langiumDocumentFactory.update(i,r)),await this.runCancelable(e,p.IndexedContent,r,i=>this.indexManager.updateContent(i,r)),await this.runCancelable(e,p.ComputedScopes,r,async i=>{const a=this.serviceRegistry.getServices(i.uri).references.ScopeComputation;i.precomputedScopes=await a.computeLocalScopes(i,r)}),await this.runCancelable(e,p.Linked,r,i=>this.serviceRegistry.getServices(i.uri).references.Linker.link(i,r)),await this.runCancelable(e,p.IndexedReferences,r,i=>this.indexManager.updateReferences(i,r));const s=e.filter(i=>this.shouldValidate(i));await this.runCancelable(s,p.Validated,r,i=>this.validate(i,r));for(const i of e){const a=this.buildState.get(i.uri.toString());a&&(a.completed=!0)}}prepareBuild(e,t){for(const r of e){const s=r.uri.toString(),i=this.buildState.get(s);(!i||i.completed)&&this.buildState.set(s,{completed:!1,options:t,result:i==null?void 0:i.result})}}async runCancelable(e,t,r,s){const i=e.filter(a=>a.state<t);for(const a of i)await R(r),await s(a),a.state=t;await this.notifyBuildPhase(i,t,r),this.currentState=t}onBuildPhase(e,t){return this.buildPhaseListeners.add(e,t),Z.create(()=>{this.buildPhaseListeners.delete(e,t)})}waitUntil(e,t,r){let s;if(t&&"path"in t?s=t:r=t,r??(r=S.None),s){const i=this.langiumDocuments.getDocument(s);if(i&&i.state>e)return Promise.resolve(s)}return this.currentState>=e?Promise.resolve(void 0):r.isCancellationRequested?Promise.reject(Y):new Promise((i,a)=>{const o=this.onBuildPhase(e,()=>{if(o.dispose(),c.dispose(),s){const u=this.langiumDocuments.getDocument(s);i(u==null?void 0:u.uri)}else i(void 0)}),c=r.onCancellationRequested(()=>{o.dispose(),c.dispose(),a(Y)})})}async notifyBuildPhase(e,t,r){if(e.length===0)return;const s=this.buildPhaseListeners.get(t);for(const i of s)await R(r),await i(e,r)}shouldValidate(e){return!!this.getBuildOptions(e).validation}async validate(e,t){var r,s;const i=this.serviceRegistry.getServices(e.uri).validation.DocumentValidator,a=this.getBuildOptions(e).validation,o=typeof a=="object"?a:void 0,c=await i.validateDocument(e,o,t);e.diagnostics?e.diagnostics.push(...c):e.diagnostics=c;const u=this.buildState.get(e.uri.toString());if(u){(r=u.result)!==null&&r!==void 0||(u.result={});const l=(s=o==null?void 0:o.categories)!==null&&s!==void 0?s:X.all;u.result.validationChecks?u.result.validationChecks.push(...l):u.result.validationChecks=[...l]}}getBuildOptions(e){var t,r;return(r=(t=this.buildState.get(e.uri.toString()))===null||t===void 0?void 0:t.options)!==null&&r!==void 0?r:{}}}class Rs{constructor(e){this.symbolIndex=new Map,this.symbolByTypeIndex=new ds,this.referenceIndex=new Map,this.documents=e.workspace.LangiumDocuments,this.serviceRegistry=e.ServiceRegistry,this.astReflection=e.AstReflection}findAllReferences(e,t){const r=D(e).uri,s=[];return this.referenceIndex.forEach(i=>{i.forEach(a=>{$.equals(a.targetUri,r)&&a.targetPath===t&&s.push(a)})}),y(s)}allElements(e,t){let r=y(this.symbolIndex.keys());return t&&(r=r.filter(s=>!t||t.has(s))),r.map(s=>this.getFileDescriptions(s,e)).flat()}getFileDescriptions(e,t){var r;return t?this.symbolByTypeIndex.get(e,t,()=>{var i;return((i=this.symbolIndex.get(e))!==null&&i!==void 0?i:[]).filter(o=>this.astReflection.isSubtype(o.type,t))}):(r=this.symbolIndex.get(e))!==null&&r!==void 0?r:[]}remove(e){const t=e.toString();this.symbolIndex.delete(t),this.symbolByTypeIndex.clear(t),this.referenceIndex.delete(t)}async updateContent(e,t=S.None){const s=await this.serviceRegistry.getServices(e.uri).references.ScopeComputation.computeExports(e,t),i=e.uri.toString();this.symbolIndex.set(i,s),this.symbolByTypeIndex.clear(i)}async updateReferences(e,t=S.None){const s=await this.serviceRegistry.getServices(e.uri).workspace.ReferenceDescriptionProvider.createDescriptions(e,t);this.referenceIndex.set(e.uri.toString(),s)}isAffected(e,t){const r=this.referenceIndex.get(e.uri.toString());return r?r.some(s=>!s.local&&t.has(s.targetUri.toString())):!1}}class Ts{constructor(e){this.initialBuildOptions={},this._ready=new Me,this.serviceRegistry=e.ServiceRegistry,this.langiumDocuments=e.workspace.LangiumDocuments,this.documentBuilder=e.workspace.DocumentBuilder,this.fileSystemProvider=e.workspace.FileSystemProvider,this.mutex=e.workspace.WorkspaceLock}get ready(){return this._ready.promise}initialize(e){var t;this.folders=(t=e.workspaceFolders)!==null&&t!==void 0?t:void 0}initialized(e){return this.mutex.write(t=>{var r;return this.initializeWorkspace((r=this.folders)!==null&&r!==void 0?r:[],t)})}async initializeWorkspace(e,t=S.None){const r=await this.performStartup(e);await R(t),await this.documentBuilder.build(r,this.initialBuildOptions,t)}async performStartup(e){const t=this.serviceRegistry.all.flatMap(i=>i.LanguageMetaData.fileExtensions),r=[],s=i=>{r.push(i),this.langiumDocuments.hasDocument(i.uri)||this.langiumDocuments.addDocument(i)};return await this.loadAdditionalDocuments(e,s),await Promise.all(e.map(i=>[i,this.getRootFolder(i)]).map(async i=>this.traverseFolder(...i,t,s))),this._ready.resolve(),r}loadAdditionalDocuments(e,t){return Promise.resolve()}getRootFolder(e){return U.parse(e.uri)}async traverseFolder(e,t,r,s){const i=await this.fileSystemProvider.readDirectory(t);await Promise.all(i.map(async a=>{if(this.includeEntry(e,a,r)){if(a.isDirectory)await this.traverseFolder(e,a.uri,r,s);else if(a.isFile){const o=await this.langiumDocuments.getOrCreateDocument(a.uri);s(o)}}}))}includeEntry(e,t,r){const s=$.basename(t.uri);if(s.startsWith("."))return!1;if(t.isDirectory)return s!=="node_modules"&&s!=="out";if(t.isFile){const i=$.extname(t.uri);return r.includes(i)}return!1}}class Ds{constructor(e){const t=e.parser.TokenBuilder.buildTokens(e.Grammar,{caseInsensitive:e.LanguageMetaData.caseInsensitive});this.tokenTypes=this.toTokenTypeDictionary(t);const r=Ye(t)?Object.values(t):t;this.chevrotainLexer=new at(r,{positionTracking:"full"})}get definition(){return this.tokenTypes}tokenize(e){var t;const r=this.chevrotainLexer.tokenize(e);return{tokens:r.tokens,errors:r.errors,hidden:(t=r.groups.hidden)!==null&&t!==void 0?t:[]}}toTokenTypeDictionary(e){if(Ye(e))return e;const t=ur(e)?Object.values(e.modes).flat():e,r={};return t.forEach(s=>r[s.name]=s),r}}function As(n){return Array.isArray(n)&&(n.length===0||"name"in n[0])}function ur(n){return n&&"modes"in n&&"defaultMode"in n}function Ye(n){return!As(n)&&!ur(n)}function Es(n,e,t){let r,s;typeof n=="string"?(s=e,r=t):(s=n.range.start,r=e),s||(s=g.create(0,0));const i=lr(n),a=Oe(r),o=Cs({lines:i,position:s,options:a});return Os({index:0,tokens:o,position:s})}function Ps(n,e){const t=Oe(e),r=lr(n);if(r.length===0)return!1;const s=r[0],i=r[r.length-1],a=t.start,o=t.end;return!!(a!=null&&a.exec(s))&&!!(o!=null&&o.exec(i))}function lr(n){let e="";return typeof n=="string"?e=n:e=n.text,e.split(dn)}const Xe=/\s*(@([\p{L}][\p{L}\p{N}]*)?)/uy,Ls=/\{(@[\p{L}][\p{L}\p{N}]*)(\s*)([^\r\n}]+)?\}/gu;function Cs(n){var e,t,r;const s=[];let i=n.position.line,a=n.position.character;for(let o=0;o<n.lines.length;o++){const c=o===0,u=o===n.lines.length-1;let l=n.lines[o],d=0;if(c&&n.options.start){const h=(e=n.options.start)===null||e===void 0?void 0:e.exec(l);h&&(d=h.index+h[0].length)}else{const h=(t=n.options.line)===null||t===void 0?void 0:t.exec(l);h&&(d=h.index+h[0].length)}if(u){const h=(r=n.options.end)===null||r===void 0?void 0:r.exec(l);h&&(l=l.substring(0,h.index))}if(l=l.substring(0,_s(l)),xe(l,d)>=l.length){if(s.length>0){const h=g.create(i,a);s.push({type:"break",content:"",range:x.create(h,h)})}}else{Xe.lastIndex=d;const h=Xe.exec(l);if(h){const k=h[0],I=h[1],ae=g.create(i,a+d),gr=g.create(i,a+d+k.length);s.push({type:"tag",content:I,range:x.create(ae,gr)}),d+=k.length,d=xe(l,d)}if(d<l.length){const k=l.substring(d),I=Array.from(k.matchAll(Ls));s.push(...$s(I,k,i,a+d))}}i++,a=0}return s.length>0&&s[s.length-1].type==="break"?s.slice(0,-1):s}function $s(n,e,t,r){const s=[];if(n.length===0){const i=g.create(t,r),a=g.create(t,r+e.length);s.push({type:"text",content:e,range:x.create(i,a)})}else{let i=0;for(const o of n){const c=o.index,u=e.substring(i,c);u.length>0&&s.push({type:"text",content:e.substring(i,c),range:x.create(g.create(t,i+r),g.create(t,c+r))});let l=u.length+1;const d=o[1];if(s.push({type:"inline-tag",content:d,range:x.create(g.create(t,i+l+r),g.create(t,i+l+d.length+r))}),l+=d.length,o.length===4){l+=o[2].length;const f=o[3];s.push({type:"text",content:f,range:x.create(g.create(t,i+l+r),g.create(t,i+l+f.length+r))})}else s.push({type:"text",content:"",range:x.create(g.create(t,i+l+r),g.create(t,i+l+r))});i=c+o[0].length}const a=e.substring(i);a.length>0&&s.push({type:"text",content:a,range:x.create(g.create(t,i+r),g.create(t,i+r+a.length))})}return s}const Is=/\S/,Ms=/\s*$/;function xe(n,e){const t=n.substring(e).match(Is);return t?e+t.index:n.length}function _s(n){const e=n.match(Ms);if(e&&typeof e.index=="number")return e.index}function Os(n){var e,t,r,s;const i=g.create(n.position.line,n.position.character);if(n.tokens.length===0)return new Ze([],x.create(i,i));const a=[];for(;n.index<n.tokens.length;){const u=Gs(n,a[a.length-1]);u&&a.push(u)}const o=(t=(e=a[0])===null||e===void 0?void 0:e.range.start)!==null&&t!==void 0?t:i,c=(s=(r=a[a.length-1])===null||r===void 0?void 0:r.range.end)!==null&&s!==void 0?s:i;return new Ze(a,x.create(o,c))}function Gs(n,e){const t=n.tokens[n.index];if(t.type==="tag")return fr(n,!1);if(t.type==="text"||t.type==="inline-tag")return dr(n);Fs(t,e),n.index++}function Fs(n,e){if(e){const t=new mr("",n.range);"inlines"in e?e.inlines.push(t):e.content.inlines.push(t)}}function dr(n){let e=n.tokens[n.index];const t=e;let r=e;const s=[];for(;e&&e.type!=="break"&&e.type!=="tag";)s.push(Bs(n)),r=e,e=n.tokens[n.index];return new Ne(s,x.create(t.range.start,r.range.end))}function Bs(n){return n.tokens[n.index].type==="inline-tag"?fr(n,!0):hr(n)}function fr(n,e){const t=n.tokens[n.index++],r=t.content.substring(1),s=n.tokens[n.index];if((s==null?void 0:s.type)==="text")if(e){const i=hr(n);return new me(r,new Ne([i],i.range),e,x.create(t.range.start,i.range.end))}else{const i=dr(n);return new me(r,i,e,x.create(t.range.start,i.range.end))}else{const i=t.range;return new me(r,new Ne([],i),e,i)}}function hr(n){const e=n.tokens[n.index++];return new mr(e.content,e.range)}function Oe(n){if(!n)return Oe({start:"/**",end:"*/",line:"*"});const{start:e,end:t,line:r}=n;return{start:he(e,!0),end:he(t,!1),line:he(r,!0)}}function he(n,e){if(typeof n=="string"||typeof n=="object"){const t=typeof n=="string"?se(n):n.source;return e?new RegExp(`^\\s*${t}`):new RegExp(`\\s*${t}\\s*$`)}else return n}class Ze{constructor(e,t){this.elements=e,this.range=t}getTag(e){return this.getAllTags().find(t=>t.name===e)}getTags(e){return this.getAllTags().filter(t=>t.name===e)}getAllTags(){return this.elements.filter(e=>"name"in e)}toString(){let e="";for(const t of this.elements)if(e.length===0)e=t.toString();else{const r=t.toString();e+=et(e)+r}return e.trim()}toMarkdown(e){let t="";for(const r of this.elements)if(t.length===0)t=r.toMarkdown(e);else{const s=r.toMarkdown(e);t+=et(t)+s}return t.trim()}}class me{constructor(e,t,r,s){this.name=e,this.content=t,this.inline=r,this.range=s}toString(){let e=`@${this.name}`;const t=this.content.toString();return this.content.inlines.length===1?e=`${e} ${t}`:this.content.inlines.length>1&&(e=`${e}
${t}`),this.inline?`{${e}}`:e}toMarkdown(e){var t,r;return(r=(t=e==null?void 0:e.renderTag)===null||t===void 0?void 0:t.call(e,this))!==null&&r!==void 0?r:this.toMarkdownDefault(e)}toMarkdownDefault(e){const t=this.content.toMarkdown(e);if(this.inline){const i=Us(this.name,t,e??{});if(typeof i=="string")return i}let r="";(e==null?void 0:e.tag)==="italic"||(e==null?void 0:e.tag)===void 0?r="*":(e==null?void 0:e.tag)==="bold"?r="**":(e==null?void 0:e.tag)==="bold-italic"&&(r="***");let s=`${r}@${this.name}${r}`;return this.content.inlines.length===1?s=`${s} — ${t}`:this.content.inlines.length>1&&(s=`${s}
${t}`),this.inline?`{${s}}`:s}}function Us(n,e,t){var r,s;if(n==="linkplain"||n==="linkcode"||n==="link"){const i=e.indexOf(" ");let a=e;if(i>0){const c=xe(e,i);a=e.substring(c),e=e.substring(0,i)}return(n==="linkcode"||n==="link"&&t.link==="code")&&(a=`\`${a}\``),(s=(r=t.renderLink)===null||r===void 0?void 0:r.call(t,e,a))!==null&&s!==void 0?s:js(e,a)}}function js(n,e){try{return U.parse(n,!0),`[${e}](${n})`}catch{return n}}class Ne{constructor(e,t){this.inlines=e,this.range=t}toString(){let e="";for(let t=0;t<this.inlines.length;t++){const r=this.inlines[t],s=this.inlines[t+1];e+=r.toString(),s&&s.range.start.line>r.range.start.line&&(e+=`
`)}return e}toMarkdown(e){let t="";for(let r=0;r<this.inlines.length;r++){const s=this.inlines[r],i=this.inlines[r+1];t+=s.toMarkdown(e),i&&i.range.start.line>s.range.start.line&&(t+=`
`)}return t}}class mr{constructor(e,t){this.text=e,this.range=t}toString(){return this.text}toMarkdown(){return this.text}}function et(n){return n.endsWith(`
`)?`
`:`

`}class Vs{constructor(e){this.indexManager=e.shared.workspace.IndexManager,this.commentProvider=e.documentation.CommentProvider}getDocumentation(e){const t=this.commentProvider.getComment(e);if(t&&Ps(t))return Es(t).toMarkdown({renderLink:(s,i)=>this.documentationLinkRenderer(e,s,i),renderTag:s=>this.documentationTagRenderer(e,s)})}documentationLinkRenderer(e,t,r){var s;const i=(s=this.findNameInPrecomputedScopes(e,t))!==null&&s!==void 0?s:this.findNameInGlobalScope(e,t);if(i&&i.nameSegment){const a=i.nameSegment.range.start.line+1,o=i.nameSegment.range.start.character+1,c=i.documentUri.with({fragment:`L${a},${o}`});return`[${r}](${c.toString()})`}else return}documentationTagRenderer(e,t){}findNameInPrecomputedScopes(e,t){const s=D(e).precomputedScopes;if(!s)return;let i=e;do{const o=s.get(i).find(c=>c.name===t);if(o)return o;i=i.$container}while(i)}findNameInGlobalScope(e,t){return this.indexManager.allElements().find(s=>s.name===t)}}class zs{constructor(e){this.grammarConfig=()=>e.parser.GrammarConfig}getComment(e){var t;return ms(e)?e.$comment:(t=Cr(e.$cstNode,this.grammarConfig().multilineCommentRules))===null||t===void 0?void 0:t.text}}class Ws{constructor(e){this.syncParser=e.parser.LangiumParser}parse(e){return Promise.resolve(this.syncParser.parse(e))}}class Ks{constructor(){this.previousTokenSource=new Ge,this.writeQueue=[],this.readQueue=[],this.done=!0}write(e){this.cancelWrite();const t=new Ge;return this.previousTokenSource=t,this.enqueue(this.writeQueue,e,t.token)}read(e){return this.enqueue(this.readQueue,e)}enqueue(e,t,r){const s=new Me,i={action:t,deferred:s,cancellationToken:r??S.None};return e.push(i),this.performNextOperation(),s.promise}async performNextOperation(){if(!this.done)return;const e=[];if(this.writeQueue.length>0)e.push(this.writeQueue.shift());else if(this.readQueue.length>0)e.push(...this.readQueue.splice(0,this.readQueue.length));else return;this.done=!1,await Promise.all(e.map(async({action:t,deferred:r,cancellationToken:s})=>{try{const i=await Promise.resolve().then(()=>t(s));r.resolve(i)}catch(i){Ie(i)?r.resolve(void 0):r.reject(i)}})),this.done=!0,this.performNextOperation()}cancelWrite(){this.previousTokenSource.cancel()}}class Js{constructor(e){this.grammarElementIdMap=new Je,this.tokenTypeIdMap=new Je,this.grammar=e.Grammar,this.lexer=e.parser.Lexer,this.linker=e.references.Linker}dehydrate(e){return{lexerErrors:e.lexerErrors.map(t=>Object.assign({},t)),parserErrors:e.parserErrors.map(t=>Object.assign({},t)),value:this.dehydrateAstNode(e.value,this.createDehyrationContext(e.value))}}createDehyrationContext(e){const t=new Map,r=new Map;for(const s of B(e))t.set(s,{});if(e.$cstNode)for(const s of ge(e.$cstNode))r.set(s,{});return{astNodes:t,cstNodes:r}}dehydrateAstNode(e,t){const r=t.astNodes.get(e);r.$type=e.$type,r.$containerIndex=e.$containerIndex,r.$containerProperty=e.$containerProperty,e.$cstNode!==void 0&&(r.$cstNode=this.dehydrateCstNode(e.$cstNode,t));for(const[s,i]of Object.entries(e))if(!s.startsWith("$"))if(Array.isArray(i)){const a=[];r[s]=a;for(const o of i)w(o)?a.push(this.dehydrateAstNode(o,t)):T(o)?a.push(this.dehydrateReference(o,t)):a.push(o)}else w(i)?r[s]=this.dehydrateAstNode(i,t):T(i)?r[s]=this.dehydrateReference(i,t):i!==void 0&&(r[s]=i);return r}dehydrateReference(e,t){const r={};return r.$refText=e.$refText,e.$refNode&&(r.$refNode=t.cstNodes.get(e.$refNode)),r}dehydrateCstNode(e,t){const r=t.cstNodes.get(e);return ct(e)?r.fullText=e.fullText:r.grammarSource=this.getGrammarElementId(e.grammarSource),r.hidden=e.hidden,r.astNode=t.astNodes.get(e.astNode),j(e)?r.content=e.content.map(s=>this.dehydrateCstNode(s,t)):ot(e)&&(r.tokenType=e.tokenType.name,r.offset=e.offset,r.length=e.length,r.startLine=e.range.start.line,r.startColumn=e.range.start.character,r.endLine=e.range.end.line,r.endColumn=e.range.end.character),r}hydrate(e){const t=e.value,r=this.createHydrationContext(t);return"$cstNode"in t&&this.hydrateCstNode(t.$cstNode,r),{lexerErrors:e.lexerErrors,parserErrors:e.parserErrors,value:this.hydrateAstNode(t,r)}}createHydrationContext(e){const t=new Map,r=new Map;for(const i of B(e))t.set(i,{});let s;if(e.$cstNode)for(const i of ge(e.$cstNode)){let a;"fullText"in i?(a=new er(i.fullText),s=a):"content"in i?a=new Ce:"tokenType"in i&&(a=this.hydrateCstLeafNode(i)),a&&(r.set(i,a),a.root=s)}return{astNodes:t,cstNodes:r}}hydrateAstNode(e,t){const r=t.astNodes.get(e);r.$type=e.$type,r.$containerIndex=e.$containerIndex,r.$containerProperty=e.$containerProperty,e.$cstNode&&(r.$cstNode=t.cstNodes.get(e.$cstNode));for(const[s,i]of Object.entries(e))if(!s.startsWith("$"))if(Array.isArray(i)){const a=[];r[s]=a;for(const o of i)w(o)?a.push(this.setParent(this.hydrateAstNode(o,t),r)):T(o)?a.push(this.hydrateReference(o,r,s,t)):a.push(o)}else w(i)?r[s]=this.setParent(this.hydrateAstNode(i,t),r):T(i)?r[s]=this.hydrateReference(i,r,s,t):i!==void 0&&(r[s]=i);return r}setParent(e,t){return e.$container=t,e}hydrateReference(e,t,r,s){return this.linker.buildReference(t,r,s.cstNodes.get(e.$refNode),e.$refText)}hydrateCstNode(e,t,r=0){const s=t.cstNodes.get(e);if(typeof e.grammarSource=="number"&&(s.grammarSource=this.getGrammarElement(e.grammarSource)),s.astNode=t.astNodes.get(e.astNode),j(s))for(const i of e.content){const a=this.hydrateCstNode(i,t,r++);s.content.push(a)}return s}hydrateCstLeafNode(e){const t=this.getTokenType(e.tokenType),r=e.offset,s=e.length,i=e.startLine,a=e.startColumn,o=e.endLine,c=e.endColumn,u=e.hidden;return new we(r,s,{start:{line:i,character:a},end:{line:o,character:c}},t,u)}getTokenType(e){return this.lexer.definition[e]}getGrammarElementId(e){return this.grammarElementIdMap.size===0&&this.createGrammarElementIdMap(),this.grammarElementIdMap.get(e)}getGrammarElement(e){this.grammarElementIdMap.size===0&&this.createGrammarElementIdMap();const t=this.grammarElementIdMap.getKey(e);if(t)return t;throw new Error("Invalid grammar element id: "+e)}createGrammarElementIdMap(){let e=0;for(const t of B(this.grammar))Mr(t)&&this.grammarElementIdMap.set(t,e++)}}function Hs(n){return{documentation:{CommentProvider:e=>new zs(e),DocumentationProvider:e=>new Vs(e)},parser:{AsyncParser:e=>new Ws(e),GrammarConfig:e=>$n(e),LangiumParser:e=>Qn(e),CompletionParser:e=>qn(e),ValueConverter:()=>new Zn,TokenBuilder:()=>new Xn,Lexer:e=>new Ds(e),ParserErrorMessageProvider:()=>new nr},workspace:{AstNodeLocator:()=>new xs,AstNodeDescriptionProvider:e=>new Ss(e),ReferenceDescriptionProvider:e=>new ks(e)},references:{Linker:e=>new ss(e),NameProvider:()=>new as,ScopeProvider:e=>new hs(e),ScopeComputation:e=>new cs(e),References:e=>new os(e)},serializer:{Hydrator:e=>new Js(e),JsonSerializer:e=>new ps(e)},validation:{DocumentValidator:e=>new vs(e),ValidationRegistry:e=>new ys(e)},shared:()=>n.shared}}function qs(n){return{ServiceRegistry:()=>new gs,workspace:{LangiumDocuments:e=>new ns(e),LangiumDocumentFactory:e=>new rs(e),DocumentBuilder:e=>new bs(e),IndexManager:e=>new Rs(e),WorkspaceManager:e=>new Ts(e),FileSystemProvider:e=>n.fileSystemProvider(e),WorkspaceLock:()=>new Ks,ConfigurationProvider:e=>new Ns(e)}}}var tt;(function(n){n.merge=(e,t)=>ee(ee({},e),t)})(tt||(tt={}));function rt(n,e,t,r,s,i,a,o,c){const u=[n,e,t,r,s,i,a,o,c].reduce(ee,{});return pr(u)}const nt=Symbol("isProxy");function pr(n,e){const t=new Proxy({},{deleteProperty:()=>!1,get:(r,s)=>it(r,s,n,e||t),getOwnPropertyDescriptor:(r,s)=>(it(r,s,n,e||t),Object.getOwnPropertyDescriptor(r,s)),has:(r,s)=>s in n,ownKeys:()=>[...Reflect.ownKeys(n),nt]});return t[nt]=!0,t}const st=Symbol();function it(n,e,t,r){if(e in n){if(n[e]instanceof Error)throw new Error("Construction failure. Please make sure that your dependencies are constructable.",{cause:n[e]});if(n[e]===st)throw new Error('Cycle detected. Please make "'+String(e)+'" lazy. See https://langium.org/docs/configuration-services/#resolving-cyclic-dependencies');return n[e]}else if(e in t){const s=t[e];n[e]=st;try{n[e]=typeof s=="function"?s(r):pr(s,r)}catch(i){throw n[e]=i instanceof Error?i:void 0,i}return n[e]}else return}function ee(n,e){if(e){for(const[t,r]of Object.entries(e))if(r!==void 0){const s=n[t];s!==null&&r!==null&&typeof s=="object"&&typeof r=="object"?n[t]=ee(s,r):n[t]=r}}return n}class Qs{readFile(){throw new Error("No file system is available.")}async readDirectory(){return[]}}const Ys={fileSystemProvider:()=>new Qs},Xs={Grammar:()=>{},LanguageMetaData:()=>({caseInsensitive:!1,fileExtensions:[".langium"],languageId:"langium"})},Zs={AstReflection:()=>new Vt};function ei(){const n=rt(qs(Ys),Zs),e=rt(Hs({shared:n}),Xs);return n.ServiceRegistry.register(e),e}function ci(n){var e;const t=ei(),r=t.serializer.JsonSerializer.deserialize(n);return t.shared.workspace.LangiumDocumentFactory.fromModel(r,U.parse(`memory://${(e=r.name)!==null&&e!==void 0?e:"grammar"}.langium`)),r}export{Rr as A,Zn as D,Ys as E,Xn as a,Hs as b,qs as c,rt as i,ci as l};
